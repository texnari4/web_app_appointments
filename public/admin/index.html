<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–¥–º–∏–Ω–∫–∞ ‚Äî –ú–∞—Å—Ç–µ—Ä–∞</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="topbar">
    <h1>–ú–∞—Å—Ç–µ—Ä–∞</h1>
    <div class="status" id="status">‚Äî</div>
  </header>

  <main class="container">
    <section class="card">
      <h2>–°–ø–∏—Å–æ–∫</h2>
      <div id="list-empty" class="muted" hidden>–ü–æ–∫–∞ –ø—É—Å—Ç–æ‚Ä¶</div>
      <ul id="masters-list" class="list"></ul>
    </section>

    <section class="card">
      <h2>–°–æ–∑–¥–∞—Ç—å</h2>
      <form id="create-form" class="form">
        <label>–ò–º—è <input name="name" required placeholder="–ò–º—è –º–∞—Å—Ç–µ—Ä–∞" /></label>
        <label>–¢–µ–ª–µ—Ñ–æ–Ω <input name="phone" required placeholder="+375..." /></label>
        <label>–ê–≤–∞—Ç–∞—Ä (URL) <input name="avatarUrl" placeholder="https://..." /></label>
        <label class="row">
          <input type="checkbox" name="isActive" checked /> –ê–∫—Ç–∏–≤–µ–Ω
        </label>
        <div class="actions">
          <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <span id="form-msg" class="muted"></span>
        </div>
      </form>
    </section>
  </main>

  <script>
    // API base. We know —Å–µ—Ä–≤–µ—Ä –æ—Ç–¥–∞–µ—Ç JSON –ø–æ /public/api/masters
    const API_BASE = "/public/api";

    function setStatus(text) {
      const el = document.getElementById("status");
      el.textContent = text;
    }

    function fmt(ts) {
      try { return new Date(ts).toLocaleString(); } catch { return ts; }
    }

    function liFor(m) {
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = \`
        <div class="title">
          <strong>\${m.name}</strong>
          <span class="badge \${m.isActive ? 'ok' : 'muted'}">\${m.isActive ? '–∞–∫—Ç–∏–≤–µ–Ω' : '–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω'}</span>
        </div>
        <div class="meta">
          <span>üì± \${m.phone || '‚Äî'}</span>
          <span>üïí \${fmt(m.updatedAt || m.createdAt)}</span>
          <span class="id">id: \${m.id}</span>
        </div>
      \`;
      return li;
    }

    async function loadMasters() {
      setStatus("–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶");
      try {
        const res = await fetch(\`\${API_BASE}/masters\`, { headers: { "accept": "application/json" } });
        if (!res.ok) throw new Error(\`HTTP \${res.status}\`);
        const data = await res.json();
        const items = Array.isArray(data?.items) ? data.items : [];
        const list = document.getElementById("masters-list");
        list.innerHTML = "";
        if (items.length === 0) {
          document.getElementById("list-empty").hidden = false;
        } else {
          document.getElementById("list-empty").hidden = true;
          for (const m of items) list.appendChild(liFor(m));
        }
        setStatus(\`–ó–∞–≥—Ä—É–∂–µ–Ω–æ: \${items.length}\`);
      } catch (e) {
        console.error(e);
        setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
      }
    }

    async function createMaster(payload) {
      // –ë—ç–∫–µ–Ω–¥ –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 200 –∏–ª–∏ 201 ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–º –æ–±–∞
      const res = await fetch(\`\${API_BASE}/masters\`, {
        method: "POST",
        headers: { "content-type": "application/json", "accept": "application/json" },
        body: JSON.stringify(payload),
      });
      const text = await res.text();
      let data = {};
      try { data = text ? JSON.parse(text) : {}; } catch {}
      if (!res.ok) {
        const msg = data?.error || data?.message || \`HTTP \${res.status}\`;
        throw new Error(msg);
      }
      return data?.item || data; // –ø–æ–¥–¥–µ—Ä–∂–∏–º {item} –∏–ª–∏ –ø–ª–æ—Å–∫–∏–π –æ–±—ä–µ–∫—Ç
    }

    function hookForm() {
      const form = document.getElementById("create-form");
      const msg = document.getElementById("form-msg");
      form.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        msg.textContent = "–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶";
        const fd = new FormData(form);
        const payload = {
          name: String(fd.get("name") || "").trim(),
          phone: String(fd.get("phone") || "").trim(),
          avatarUrl: String(fd.get("avatarUrl") || "").trim() || null,
          isActive: !!fd.get("isActive"),
        };
        try {
          const item = await createMaster(payload);
          msg.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úî";
          // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ –¥–æ–±–∞–≤–∏–º –≤ —Å–ø–∏—Å–æ–∫
          const list = document.getElementById("masters-list");
          list.prepend(liFor(item));
          document.getElementById("list-empty").hidden = true;
          form.reset();
          form.elements["isActive"].checked = true;
          setStatus("–û–ö");
        } catch (e) {
          console.error(e);
          msg.textContent = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è";
          setStatus("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        }
      });
    }

    hookForm();
    loadMasters();
  </script>
</body>
</html>
