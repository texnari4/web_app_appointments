<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Админка — Мастера</title>
  <style>
    :root{--bg:#0b0f14;--panel:#111827;--muted:#6b7280;--txt:#e5e7eb;--accent:#14b8a6;--accent-2:#22d3ee;--danger:#ef4444;--ok:#22c55e}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0a0f16,#0b1220);color:var(--txt);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial}
    .wrap{display:grid;grid-template-columns:340px 1fr;gap:20px;max-width:1200px;margin:0 auto;padding:20px}
    header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .brand{font-weight:700;letter-spacing:.2px}
    .status{font-size:12px;color:var(--muted)}
    .card{background:radial-gradient(1200px 200px at -10% -10%,rgba(20,184,166,.08),transparent 60%),radial-gradient(1000px 160px at 120% 0,rgba(34,211,238,.08),transparent 60%),var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 10px 35px rgba(0,0,0,.3);padding:16px}
    .h2{margin:0 0 10px;font-size:16px;font-weight:700}
    form .row{display:flex;gap:10px}
    label{display:block;font-size:12px;color:var(--muted);margin:12px 0 6px}
    input[type=text], input[type=tel], input[type=url]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0e1622;color:var(--txt);outline:none}
    input::placeholder{color:#94a3b8}
    .actions{display:flex;gap:10px;margin-top:14px}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#051014}
    .btn-secondary{background:#1f2937;color:var(--txt)}
    .btn-primary[disabled]{opacity:.6;cursor:not-allowed}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .item{display:flex;gap:12px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.06);background:#0f172a}
    .avatar{width:48px;height:48px;border-radius:10px;object-fit:cover;background:#0b1220;border:1px solid rgba(255,255,255,.06)}
    .name{font-weight:700}
    .muted{color:var(--muted);font-size:12px}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;border:1px solid rgba(255,255,255,.08);padding:10px 12px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.35);opacity:0;transform:translateY(6px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .toolbar input{flex:1}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(20,184,166,.15);color:var(--accent);font-size:11px;margin-left:6px}
    @media (max-width:900px){.wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">Админка • Мастера <span id="count" class="badge">0</span></div>
      <div class="status" id="status">готово</div>
    </header>

    <section class="card">
      <div class="h2">Добавить мастера</div>
      <form id="f">
        <label>Имя</label>
        <input id="name" type="text" placeholder="Напр. Юлия" required />
        <div class="row">
          <div style="flex:1">
            <label>Телефон</label>
            <input id="phone" type="text" placeholder="+375..." required />
          </div>
          <div style="flex:1">
            <label>Avatar URL</label>
            <input id="avatar" type="url" placeholder="https://..." />
          </div>
        </div>
        <div class="actions">
          <button class="btn-primary" id="saveBtn" type="submit">Сохранить</button>
          <button class="btn-secondary" type="button" id="resetBtn">Очистить</button>
        </div>
      </form>
    </section>

    <section class="card">
      <div class="h2">Список мастеров</div>
      <div class="toolbar">
        <input id="q" type="text" placeholder="Поиск по имени или телефону" />
        <button class="btn-secondary" id="refreshBtn" type="button">Обновить</button>
      </div>
      <div id="list" class="list" aria-live="polite"></div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    (function(){
      "use strict";

      var API = "/public/api/masters";
      var listEl = document.getElementById("list");
      var countEl = document.getElementById("count");
      var statusEl = document.getElementById("status");
      var toastEl = document.getElementById("toast");
      var formEl = document.getElementById("f");
      var btnSave = document.getElementById("saveBtn");
      var btnReset = document.getElementById("resetBtn");
      var btnRefresh = document.getElementById("refreshBtn");
      var qEl = document.getElementById("q");
      var memory = []; // текущее состояние

      function showToast(text){
        toastEl.textContent = text;
        toastEl.classList.add("show");
        setTimeout(function(){ toastEl.classList.remove("show"); }, 1500);
      }

      function setBusy(flag, text){
        if(flag){ statusEl.textContent = text || "выполняю..."; }
        else { statusEl.textContent = "готово"; }
        btnSave.disabled = !!flag;
      }

      function normalizeItems(x){
        if(!x) return [];
        if (Array.isArray(x)) return x;
        if (x.items && Array.isArray(x.items)) return x.items;
        return [];
      }

      function render(items){
        memory = items.slice();
        countEl.textContent = String(items.length);
        listEl.innerHTML = "";
        for (var i=0;i<items.length;i++){
          var it = items[i];
          var card = document.createElement("div");
          card.className = "item";
          var img = document.createElement("img");
          img.className = "avatar";
          img.alt = "";
          img.src = it.avatarUrl || "";
          var body = document.createElement("div");
          var name = document.createElement("div");
          name.className = "name";
          name.textContent = it.name || "(без имени)";
          var phone = document.createElement("div");
          phone.className = "muted";
          phone.textContent = it.phone || "";
          var meta = document.createElement("div");
          meta.className = "muted";
          meta.textContent = (it.isActive ? "активен" : "скрыт") + " • " + (it.createdAt || "");
          body.appendChild(name); body.appendChild(phone); body.appendChild(meta);
          card.appendChild(img); card.appendChild(body);
          listEl.appendChild(card);
        }
      }

      function fetchList(){
        setBusy(true,"загружаю...");
        return fetch(API, {
          method: "GET",
          headers: {
            "Accept":"application/json",
            "Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate",
            "Pragma":"no-cache"
          },
          cache: "no-store"
        })
        .then(function(r){ return r.json().catch(function(){ return []; }); })
        .then(function(data){ render(normalizeItems(data)); })
        .catch(function(err){ console.error(err); showToast("Не удалось загрузить"); })
        .finally(function(){ setBusy(false); });
      }

      function doSave(payload){
        setBusy(true,"сохраняю...");
        return fetch(API, {
          method: "POST",
          headers: { "Content-Type":"application/json", "Accept":"application/json" },
          body: JSON.stringify(payload),
          cache: "no-store"
        })
        .then(function(r){
          // Сервер может вернуть 201/200 без тела — это ок
          if(!r.ok){ throw new Error("HTTP "+r.status); }
          return r.text().then(function(t){
            try { return t ? JSON.parse(t) : null; } catch(_){ return null; }
          });
        })
        .then(function(_data){
          showToast("Сохранено");
          // Жёстко перезагружаем список, чтобы не зависеть от ответа
          return fetchList();
        })
        .catch(function(err){
          console.error(err);
          showToast("Ошибка сохранения");
        })
        .finally(function(){ setBusy(false); });
      }

      // Поиск по локальному состоянию без запроса
      function filterLocal(q){
        var s = (q||"").trim().toLowerCase();
        if(!s){ render(memory); return; }
        var f = memory.filter(function(it){
          return String(it.name||"").toLowerCase().indexOf(s) >= 0 ||
                 String(it.phone||"").toLowerCase().indexOf(s) >= 0;
        });
        render(f);
      }

      // handlers
      formEl.addEventListener("submit", function(ev){
        ev.preventDefault();
        var payload = {
          name: document.getElementById("name").value.trim(),
          phone: document.getElementById("phone").value.trim(),
          avatarUrl: document.getElementById("avatar").value.trim(),
          isActive: true
        };
        if(!payload.name || !payload.phone){
          showToast("Заполните имя и телефон"); return;
        }
        doSave(payload).then(function(){
          formEl.reset();
          document.getElementById("name").focus();
        });
      });

      btnReset.addEventListener("click", function(){
        formEl.reset(); document.getElementById("name").focus();
      });

      btnRefresh.addEventListener("click", function(){ fetchList(); });

      qEl.addEventListener("input", function(){ filterLocal(qEl.value); });

      // Первичная загрузка
      fetchList();
    })();
  </script>
</body>
</html>
