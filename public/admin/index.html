<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin — Masters</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 20px; }
      form, table { margin: 12px 0; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ddd; padding: 8px; }
      th { background: #f6f6f6; text-align: left; }
      input, textarea { width: 100%; padding: 8px; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .muted { color: #666; }
      button { padding: 8px 12px; }
    </style>
  </head>
  <body>
    <h1>Admin — Masters</h1>

    <section>
      <h2>Create Master</h2>
      <form id="createForm">
        <div class="row">
          <label>Имя <input name="name" required /></label>
          <label>Телефон <input name="phone" /></label>
        </div>
        <label>Bio <textarea name="bio" rows="3"></textarea></label>
        <button type="submit">Создать</button>
        <span id="createStatus" class="muted"></span>
      </form>
    </section>

    <section>
      <h2>Masters</h2>
      <table>
        <thead><tr><th>id</th><th>name</th><th>phone</th><th>created</th><th>actions</th></tr></thead>
        <tbody id="listBody"></tbody>
      </table>
    </section>

    <script>
      const $ = (s)=>document.querySelector(s);

      async function load() {
        const r = await fetch('/api/masters');
        const j = await r.json();
        const tbody = $('#listBody');
        tbody.innerHTML = '';
        (j.data||[]).forEach(m => {
          const tr = document.createElement('tr');
          tr.innerHTML = \`
            <td>\${m.id}</td>
            <td><input value="\${m.name}" data-id="\${m.id}" data-field="name"/></td>
            <td><input value="\${m.phone||''}" data-id="\${m.id}" data-field="phone"/></td>
            <td>\${new Date(m.createdAt).toLocaleString()}</td>
            <td>
              <button data-id="\${m.id}" data-action="save">Save</button>
              <button data-id="\${m.id}" data-action="del">Del</button>
            </td>\`;
          tbody.appendChild(tr);
        });
      }

      $('#createForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(e.currentTarget);
        const body = Object.fromEntries(fd.entries());
        const r = await fetch('/api/masters', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const j = await r.json();
        $('#createStatus').textContent = j.ok ? '✔ создано' : '✖ ошибка';
        await load();
      });

      document.body.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.dataset.id;
        const action = btn.dataset.action;
        if (action === 'del') {
          await fetch('/api/masters/'+id, { method:'DELETE' });
          await load();
        } else if (action === 'save') {
          const rowInputs = [...document.querySelectorAll('input[data-id="'+id+'"]')];
          const payload = Object.fromEntries(rowInputs.map(i=>[i.dataset.field, i.value]));
          await fetch('/api/masters/'+id, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
          await load();
        }
      });

      load();
    </script>
  </body>
</html>
