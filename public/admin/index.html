<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Админка — Beauty App</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="container">
    <h1>Мастера</h1>
    <form id="createForm" class="card">
      <div class="grid">
        <label>Имя
          <input name="name" required />
        </label>
        <label>Телефон
          <input name="phone" required />
        </label>
        <label>Аватар URL
          <input name="avatarUrl" />
        </label>
        <label class="row">
          <input type="checkbox" name="isActive" checked />
          Активен
        </label>
      </div>
      <button type="submit">Сохранить</button>
      <span id="error" class="error" hidden></span>
    </form>

    <ul id="list" class="list"></ul>
  </div>

  <script>
    const listEl = document.getElementById('list');
    const form = document.getElementById('createForm');
    const errorEl = document.getElementById('error');

    async function fetchList() {
      const r = await fetch('/public/api/masters');
      const data = await r.json();
      renderList(data.items || []);
    }

    function renderList(items) {
      listEl.innerHTML = '';
      for (const m of items) {
        const li = document.createElement('li');
        li.className = 'item';
        li.innerHTML = \`
          <img src="\${m.avatarUrl || 'https://placehold.co/48x48'}" alt="" />
          <div class="col">
            <div class="name">\${m.name}</div>
            <div class="meta">\${m.phone} · \${m.isActive ? 'активен' : 'скрыт'}</div>
          </div>
        \`;
        listEl.appendChild(li);
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorEl.hidden = true;
      const fd = new FormData(form);
      const payload = {
        name: fd.get('name'),
        phone: fd.get('phone'),
        avatarUrl: fd.get('avatarUrl'),
        isActive: fd.get('isActive') === 'on'
      };
      try {
        const r = await fetch('/public/api/masters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await r.json();
        if (!r.ok || data.error) throw new Error(data.error || 'Ошибка сохранения');

        // Optimistic update
        const current = Array.from(listEl.querySelectorAll('li')).map(li => ({
          name: li.querySelector('.name').textContent,
          phone: li.querySelector('.meta').textContent.split(' · ')[0],
          avatarUrl: li.querySelector('img').src,
          isActive: li.querySelector('.meta').textContent.includes('активен')
        }));
        renderList([{...payload, ...data.item}, ...current]);

        form.reset();
        form.querySelector('input[name="isActive"]').checked = true;
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.hidden = false;
      }
    });

    fetchList();
  </script>
</body>
</html>