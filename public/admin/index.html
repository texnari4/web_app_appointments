
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Админка — Мастера</title>
  <link rel="icon" href="data:," />
  <style>
    :root { --bg:#0b0b0c; --card:#111215; --text:#e7e7ea; --muted:#a1a1aa; --accent:#0a84ff; --ok:#34c759; --err:#ff3b30; --border:#1f2024; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;}
    header{position:sticky;top:0;background:rgba(11,11,12,.7);backdrop-filter:saturate(180%) blur(20px);padding:14px 20px;border-bottom:1px solid var(--border);}
    h1{margin:0;font-size:18px;font-weight:600;letter-spacing:.2px}
    main{max-width:980px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 1px 0 rgba(255,255,255,.02) inset}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input{width:100%;padding:10px 12px;border:1px solid var(--border);background:#0e0f12;color:var(--text);border-radius:12px;outline:none}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{background:var(--accent);border:none;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:wait}
    ul{list-style:none;margin:0;padding:0;display:grid;gap:10px}
    .item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#0e0f12}
    .avatar{width:40px;height:40px;border-radius:10px;object-fit:cover;background:#1a1b20}
    .muted{color:var(--muted);font-size:12px}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111214;border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:12px;display:none}
    nav a{color:var(--muted);text-decoration:none;margin-right:12px}
    nav a.active{color:var(--text)}
  </style>
</head>
<body>
<header>
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h1>Админка · Мастера</h1>
    <nav>
      <a href="/admin/" class="active">Мастера</a>
      <a href="/admin/appointments">Записи</a>
    </nav>
  </div>
</header>
<main>
  <section class="card">
    <div class="toolbar">
      <strong>Добавить мастера</strong>
    </div>
    <form id="form">
      <label>Имя</label>
      <input id="name" required placeholder="Например, Юлия" />
      <div class="row">
        <div>
          <label>Телефон</label>
          <input id="phone" required placeholder="+375..." />
        </div>
        <div>
          <label>Avatar URL</label>
          <input id="avatarUrl" placeholder="https://..." />
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;">
        <button class="btn" id="saveBtn">Сохранить</button>
      </div>
    </form>
  </section>
  <section class="card">
    <div class="toolbar">
      <strong>Список мастеров</strong>
      <input id="search" placeholder="Поиск..." style="max-width:220px" />
    </div>
    <ul id="list"></ul>
    <div class="muted" id="empty" style="display:none">Записей нет</div>
  </section>
</main>
<div class="toast" id="toast"></div>
<script>
  const API = "/public/api/masters";
  const listEl = document.getElementById("list");
  const emptyEl = document.getElementById("empty");
  const form = document.getElementById("form");
  const saveBtn = document.getElementById("saveBtn");
  const toast = document.getElementById("toast");
  const search = document.getElementById("search");

  const state = { items: [] };

  function showToast(text, ok=true){
    toast.textContent = text;
    toast.style.display = "block";
    toast.style.borderColor = ok ? "var(--ok)" : "var(--err)";
    setTimeout(()=>toast.style.display="none", 1800);
  }

  function render(){
    const q = search.value?.toLowerCase?.() || "";
    const items = state.items.filter(x => x.name.toLowerCase().includes(q) || x.phone.includes(q));
    listEl.innerHTML = "";
    items.forEach(x => {
      const li = document.createElement("li");
      li.className="item";
      li.innerHTML = \`
        <img class="avatar" src="\${x.avatarUrl || ""}" alt="" onerror="this.style.opacity=.2" />
        <div style="flex:1">
          <div style="font-weight:600">\${x.name}</div>
          <div class="muted">\${x.phone}</div>
        </div>
        <span class="muted">\${new Date(x.createdAt).toLocaleString()}</span>
      \`;
      listEl.appendChild(li);
    });
    emptyEl.style.display = items.length ? "none" : "block";
  }

  async function fetchList(){
    const r = await fetch(API, { cache:"no-store", headers: { "Cache-Control":"no-store","Pragma":"no-cache" } });
    const j = await r.json();
    state.items = j.items || [];
    render();
  }

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    saveBtn.disabled = true;
    try {
      const body = {
        name: document.getElementById("name").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        avatarUrl: document.getElementById("avatarUrl").value.trim() || undefined,
        isActive: true
      };
      const r = await fetch(API, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!r.ok){
        const err = await r.json().catch(()=>({}));
        showToast("Ошибка сохранения", false);
        console.error("save error", err);
      } else {
        showToast("Сохранено");
        await fetchList(); // instant refresh
        form.reset();
      }
    } finally {
      saveBtn.disabled = false;
    }
  });

  search.addEventListener("input", render);
  fetchList();
</script>
</body>
</html>
