import { readFileSync } from 'fs';
import { join } from 'path';
// ... other imports and code ...

// Inside your request handler or server logic

// Serve static pages
if (pathname === '/client') {
  const html = readFileSync(join(__dirname, 'templates', 'client.html'), 'utf8');
  return sendHTML(res, 200, html);
}

if (pathname === '/admin') {
  const html = readFileSync(join(__dirname, 'templates', 'admin.html'), 'utf8');
  return sendHTML(res, 200, html);
}

if (pathname === '/manager'){
  const html = readFileSync(join(__dirname, 'templates', 'managel.html'),'utf8');
  return sendHTML(res, 200, html);
}

// Health endpoint
if (pathname === '/health') {
  const html = `
    <html>
      <body>
        <h1>Health Check</h1>
        <p><a href="/api/backup/export">Скачать бэкап</a> · <a href="/client">Client</a> · <a href="/admin">Admin</a> · <a href="/manager">Manager</a></p>
        <!-- other health info -->
      </body>
    </html>
  `;
  return sendHTML(res, 200, html);
}

// List bookings with optional filters: from, to (YYYY-MM-DD), masterId, status, q
if (pathname === '/api/bookings' && req.method === 'GET'){
  const bookings = readJSON(bookingsFile, []);
  const from = (searchParams.get('from')||'').trim();
  const to = (searchParams.get('to')||'').trim();
  const masterId = (searchParams.get('masterId')||'').trim();
  const status = (searchParams.get('status')||'').trim();
  const q = (searchParams.get('q')||'').trim().toLowerCase();

  let out = bookings.slice();
  if (from) out = out.filter(b => b.date >= from);
  if (to)   out = out.filter(b => b.date <= to);
  if (masterId) out = out.filter(b => String(b.masterId) === String(masterId));
  if (status) out = out.filter(b => String(b.status) === String(status));
  if (q) out = out.filter(b =>
    (b.clientName||'').toLowerCase().includes(q) ||
    (b.clientPhone||'').toLowerCase().includes(q) ||
    (b.serviceName||'').toLowerCase().includes(q)
  );
  out.sort((a,b)=> (a.date.localeCompare(b.date)) || ((a.startTime||'').localeCompare(b.startTime||'')) );
  return sendJSON(res, 200, out);
}

// ... existing POST /api/bookings handler here ...

// Manager: list clients (based on contacts.json)
if (pathname === '/api/clients' && req.method === 'GET'){
  const list = readJSON(contactsFile, []);
  const q = (searchParams.get('q')||'').trim().toLowerCase();
  let out = list.slice();
  if (q) out = out.filter(c => `${c.first_name||''} ${c.last_name||''}`.toLowerCase().includes(q) || String(c.phone||'').toLowerCase().includes(q));
  out.sort((a,b)=> (a.first_name||'').localeCompare(b.first_name||''));
  return sendJSON(res, 200, out);
}

// ... rest of your code ...
