<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Менеджер — Beauty</title>
  <style>
    /* Base */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#f6f7fb 0%,#f0f3f8 45%,#eef1f7 100%);color:#111827;}
    a{color:#007aff;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:16px 12px 28px}

    /* Header / Tabs */
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:10}
    .header-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;max-width:1100px;margin:0 auto}
    .brand{font-weight:800;letter-spacing:-.02em}
    .tabs{display:flex;gap:6px}
    .tab{padding:8px 14px;border-radius:10px;font-weight:700;color:#374151;cursor:pointer;user-select:none;border:1px solid rgba(148,163,184,.35);background:#fff}
    .tab.active{border-color:#007aff;background:#007aff;color:#fff;box-shadow:0 10px 24px -12px rgba(0,122,255,.4)}

    /* Layout */
    main{padding:16px 0}
    section.view{display:none}
    section.view.active{display:block}

    /* Cards / Inputs */
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 30px 60px -40px rgba(15,23,42,.25);padding:16px;margin-bottom:16px}
    h2{margin:0 0 10px;font-size:20px;font-weight:800;letter-spacing:-.01em}
    .muted{color:#6b7280}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grow{flex:1 1 240px}

    input,select,textarea{width:100%;padding:12px 14px;border:1px solid rgba(148,163,184,.45);border-radius:12px;font:inherit;font-size:16px;line-height:1.2;background:#fff}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.45);background:#fff;color:#111827;font-weight:700;cursor:pointer;font-size:16px}
    .btn.primary{border:none;background:#007aff;color:#fff;box-shadow:0 20px 32px -20px rgba(0,122,255,.5)}
    .btn.ghost{background:#fff}

    /* Tables */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eef2f7;vertical-align:middle}
    th{color:#6b7280;font-weight:700;text-align:left;font-size:13px;text-transform:uppercase;letter-spacing:.04em}
    tr:hover td{background:#fafbff}

    /* Toolbar */
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .search{position:relative;min-width:220px}
    .search input{padding-left:38px}
    .search svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.55}

    /* Banner */
    .banner{position:fixed;left:0;right:0;bottom:18px;margin:0 auto;max-width:900px;padding:12px 16px;border-radius:12px;background:linear-gradient(135deg,rgba(94,197,255,.95),rgba(0,122,255,.95));color:#fff;font-weight:700;text-align:center;opacity:0;pointer-events:none;transform:translateY(6px);transition:opacity .2s,transform .2s}
    .banner.show{opacity:1;transform:translateY(0)}
    .banner.error{background:linear-gradient(135deg,rgba(255,95,95,.95),rgba(244,63,94,.95))}

    /* Calendar grid */
    .hour-col{display:grid;gap:8px}
    .time-cell{height:44px;color:#6b7280;font-size:12px;display:flex;align-items:flex-start;justify-content:flex-end;padding:6px 8px}
    .slot-col{position:relative;border-left:1px dashed #e5e7eb}
    .event{position:absolute;left:8px;right:8px;border-radius:10px;padding:8px 10px;background:#eef6ff;border:1px solid #c7ddff}
    .event .t{font-weight:700}
    .event .m{color:#374151;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">Менеджер</div>
      <nav class="tabs" id="navTabs">
        <div class="tab active" data-tab="bookings">Записи</div>
        <div class="tab" data-tab="clients">Клиенты</div>
        <div class="tab" data-tab="services">Услуги</div>
      </nav>
    </div>
  </header>

  <div class="container">
    <main>
      <!-- Записи -->
      <section id="view-bookings" class="view active">
        <div class="card">
          <h2>Записи</h2>
          <div class="toolbar">
            <div class="search grow"><input id="searchBookings" placeholder="Поиск по клиенту/услуге" /><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-3.5-3.5" stroke="#111827" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#111827" stroke-width="2" fill="none"/></svg></div>
            <select id="filterMaster" class="btn ghost"><option value="">Все мастера</option></select>
            <select id="filterStatus" class="btn ghost">
              <option value="">Все статусы</option>
              <option value="pending">Новые</option>
              <option value="confirmed">Подтверждённые</option>
              <option value="done">Выполнено</option>
              <option value="canceled">Отменено</option>
            </select>
            <button id="addBooking" class="btn primary">+ Новая запись</button>
          </div>

          <div class="row" style="align-items:center;justify-content:space-between;margin-top:6px">
            <div class="row" style="gap:8px">
              <button class="btn ghost" id="calPrev">‹</button>
              <div id="calTitle" style="font-weight:800"></div>
              <button class="btn ghost" id="calNext">›</button>
            </div>
            <div class="row" style="gap:6px">
              <button class="btn ghost" data-view="day" id="viewDay">День</button>
              <button class="btn ghost" data-view="week" id="viewWeek">Неделя</button>
            </div>
          </div>

          <div class="card" style="padding:0;margin:0;border:none;box-shadow:none">
            <table id="tblBookings">
              <thead><tr>
                <th>Дата</th><th>Время</th><th>Клиент</th><th>Телефон</th><th>Услуга</th><th>Мастер</th><th>Статус</th><th></th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <div id="calendarBoard" class="card" style="margin-top:10px">
            <div id="dayGrid" style="display:grid;grid-template-columns:80px 1fr;gap:8px"></div>
          </div>
        </div>
      </section>

      <!-- Клиенты -->
      <section id="view-clients" class="view">
        <div class="card">
          <h2>Клиенты</h2>
          <div class="toolbar">
            <div class="search grow"><input id="searchClients" placeholder="Поиск клиента" /><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-3.5-3.5" stroke="#111827" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#111827" stroke-width="2" fill="none"/></svg></div>
            <button id="addClient" class="btn primary">+ Новый клиент</button>
          </div>
          <div class="card" style="padding:0;margin:0;border:none;box-shadow:none">
            <table id="tblClients">
              <thead><tr>
                <th>Имя</th><th>Телефон</th><th>Telegram</th><th>Заметки</th><th></th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Услуги -->
      <section id="view-services" class="view">
        <div class="card">
          <h2>Услуги</h2>
          <div class="toolbar">
            <div class="search grow"><input id="searchServices" placeholder="Поиск услуги" /><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-3.5-3.5" stroke="#111827" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#111827" stroke-width="2" fill="none"/></svg></div>
            <button id="addService" class="btn primary">+ Новая услуга</button>
          </div>
          <div class="card" style="padding:0;margin:0;border:none;box-shadow:none">
            <table id="tblServices">
              <thead><tr>
                <th>Название</th><th>Категория</th><th>Длительность</th><th>Цена</th><th>Онлайн</th><th></th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="banner" id="banner" hidden></div>

<script>
(function(){
  // Tabs
  const tabs = document.getElementById('navTabs');
  tabs.addEventListener('click', (e)=>{
    const el = e.target.closest('.tab'); if(!el) return;
    document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t===el));
    const tab = el.dataset.tab;
    document.querySelectorAll('section.view').forEach(v=>v.classList.toggle('active', v.id === 'view-'+tab));
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // Telegram WebApp auth cookie (SSO)
  async function ensureTgAuth(){
    try{
      const tg = window.Telegram && window.Telegram.WebApp;
      if (!tg || !tg.initData || tg.initData.length < 10) return;
      await fetch('/auth/telegram', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ initData: tg.initData }) });
    }catch(e){ /* noop */ }
  }
  try{ const tg = window.Telegram && window.Telegram.WebApp; if(tg){ tg.ready&&tg.ready(); tg.expand&&tg.expand(); } }catch{}
  ensureTgAuth();

  // Minimal bootstrap data loads (placeholders)
  async function loadMasters(){ try{ const r=await fetch('/api/masters'); const list=r.ok?await r.json():[]; const sel=document.getElementById('filterMaster'); sel.innerHTML='<option value="">Все мастера</option>'+ list.map(m=>`<option value="${m.id}">${m.name}</option>`).join(''); }catch{} }
  async function loadBookings(){ try{ const r=await fetch('/api/bookings'); const list=r.ok?await r.json():[]; const tb=document.querySelector('#tblBookings tbody'); tb.innerHTML=list.map(b=>`<tr><td>${b.date||''}</td><td>${b.startTime||''}</td><td>${b.clientName||''}</td><td>${b.clientPhone||''}</td><td>${b.serviceName||b.serviceId||''}</td><td>${b.masterId||''}</td><td>${b.status||''}</td><td><button class='btn ghost' data-id='${b.id}'>⋯</button></td></tr>`).join(''); }catch{} }
  async function loadClients(){ try{ const r=await fetch('/api/clients'); const list=r.ok?await r.json():[]; const tb=document.querySelector('#tblClients tbody'); tb.innerHTML=list.map(c=>`<tr><td>${(c.first_name||'')+' '+(c.last_name||'')}</td><td>${c.phone||''}</td><td>${c.id||''}</td><td>${c.notes||''}</td><td><button class='btn ghost' data-id='${c.id}'>⋯</button></td></tr>`).join(''); }catch{} }
  async function loadServices(){ try{ const r=await fetch('/api/services'); const list=r.ok?await r.json():[]; const tb=document.querySelector('#tblServices tbody'); tb.innerHTML=list.map(s=>`<tr><td>${s.name||''}</td><td>${s.groupId||''}</td><td>${s.duration||''} мин</td><td>${s.price??''}</td><td>${s.onlineEnabled? 'Да':'Нет'}</td><td><button class='btn ghost' data-id='${s.id}'>⋯</button></td></tr>`).join(''); }catch{} }

  loadMasters();
  loadBookings();
  loadClients();
  loadServices();

  // --- Simple calendar (Day/Week) ---
  const calTitle = document.getElementById('calTitle');
  const calPrev = document.getElementById('calPrev');
  const calNext = document.getElementById('calNext');
  const dayGrid = document.getElementById('dayGrid');
  let view = 'day';
  let cursor = new Date(); // current day/week start

  function ymd(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function toMin(t){ const [h,m]=String(t||'00:00').split(':').map(Number); return h*60+m; }

  function renderDay(bookings){
    dayGrid.innerHTML='';
    const hours=[]; for(let h=9; h<=21; h++){ hours.push(`${String(h).padStart(2,'0')}:00`); }
    const hourCol=document.createElement('div'); hourCol.className='hour-col';
    hours.forEach(h=>{ const c=document.createElement('div'); c.className='time-cell'; c.textContent=h; hourCol.appendChild(c); });
    const slotCol=document.createElement('div'); slotCol.className='slot-col'; slotCol.style.minHeight=(hours.length*44)+'px';

    // draw events (simple vertical stacking by time)
    const perMin=44/60; // px per minute
    bookings.forEach(b=>{
      const top = Math.round((toMin(b.startTime)-(9*60))*perMin);
      const dur = Number(b.duration||b.serviceDuration||30);
      const height = Math.max(36, Math.round(dur*perMin));
      const ev = document.createElement('div'); ev.className='event'; ev.style.top= (top<0?0:top)+'px'; ev.style.height=height+'px';
      ev.innerHTML = `<div class='t'>${b.startTime} • ${b.clientName||''}</div><div class='m'>${b.serviceName||''} · ${b.masterId||''}</div>`;
      slotCol.appendChild(ev);
    });

    dayGrid.appendChild(hourCol);
    dayGrid.appendChild(slotCol);
  }

  async function refreshCalendar(){
    const from = ymd(cursor);
    const to = ymd(cursor);
    calTitle.textContent = new Date(from).toLocaleDateString('ru-RU',{weekday:'long', day:'numeric', month:'long'});
    const params = new URLSearchParams({ from, to, masterId: document.getElementById('filterMaster').value||'' , status: document.getElementById('filterStatus').value||'' , q: document.getElementById('searchBookings').value||'' });
    const r = await fetch('/api/bookings?'+params.toString());
    const list = r.ok ? await r.json() : [];
    renderDay(list);
  }

  calPrev.addEventListener('click', ()=>{ cursor = addDays(cursor, view==='day'?-1:-7); refreshCalendar(); });
  calNext.addEventListener('click', ()=>{ cursor = addDays(cursor, view==='day'?+1:+7); refreshCalendar(); });
  document.getElementById('viewDay').addEventListener('click', ()=>{ view='day'; refreshCalendar(); });
  document.getElementById('viewWeek').addEventListener('click', ()=>{ view='week'; /* future: week grid */ refreshCalendar(); });

  // react to filters
  document.getElementById('filterMaster').addEventListener('change', refreshCalendar);
  document.getElementById('filterStatus').addEventListener('change', refreshCalendar);
  document.getElementById('searchBookings').addEventListener('input', ()=>{ clearTimeout(window.__srch); window.__srch=setTimeout(refreshCalendar, 250); });

  // first paint
  refreshCalendar();
})();
</script>
</body>
</html>



# --- manager.html ---
cat <<'EOF' >  templates/managel.html
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Менеджер — Записи</title>
  <style>
    /* Base */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f6f7fb;color:#111827;}
    .wrap{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}
    a{color:#007aff;text-decoration:none}

    /* Top bar */
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:20}
    .header-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px}
    .brand{font-weight:800;letter-spacing:-.02em}

    /* View switcher */
    .views{display:flex;gap:8px}
    .views .chip{padding:8px 14px;border-radius:12px;border:1px solid #d1d5db;background:#fff;color:#374151;font-weight:700;cursor:pointer}
    .views .chip.active{background:#007aff;border-color:#007aff;color:#fff}

    /* Days scroller */
    .days{display:flex;gap:8px;overflow-x:auto;padding:8px 12px;background:#fff;border-bottom:1px solid #e5e7eb}
    .day{min-width:64px;text-align:center;border-radius:12px;border:1px solid #e5e7eb;background:#fff;padding:8px 10px;cursor:pointer}
    .day .dow{font-size:12px;color:#6b7280}
    .day .num{font-weight:800}
    .day.active{background:#007aff;border-color:#007aff;color:#fff}
    .day.active .dow{color:#eef2ff}

    /* Content */
    main{padding:12px}
    .date-label{font-weight:800;margin:6px 2px 10px}

    /* Day grid */
    .grid{display:grid;grid-template-columns:64px 1fr;gap:10px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 24px 40px -32px rgba(15,23,42,.25);padding:10px}
    .hours{display:grid}
    .hcell{height:56px;color:#6b7280;font-size:12px;display:flex;align-items:flex-start;justify-content:flex-end;padding:8px}
    .lane{position:relative;border-left:1px dashed #e5e7eb;min-height:56px}
    .event{position:absolute;left:10px;right:10px;border-radius:12px;padding:8px 10px;background:#eef6ff;border:1px solid #c7ddff}
    .event .t{font-weight:700}
    .event .m{color:#374151;font-size:12px}

    /* FAB */
    .fab{position:fixed;right:18px;bottom:84px;width:56px;height:56px;border-radius:50%;background:#007aff;color:#fff;display:flex;align-items:center;justify-content:center;font-size:28px;line-height:0;box-shadow:0 16px 36px -16px rgba(0,122,255,.5);cursor:pointer;border:none}

    /* Bottom nav */
    .bottom{position:sticky;bottom:0;background:#fff;border-top:1px solid #e5e7eb;padding:8px}
    .tabs{display:flex;justify-content:space-around;gap:6px}
    .tab{display:grid;justify-items:center;gap:4px;color:#6b7280;font-size:12px}
    .tab.active{color:#007aff;font-weight:700}

    /* Modal */
.modal{position:fixed;inset:0;background:rgba(15,23,42,.4);display:none;align-items:center;justify-content:center;z-index:40;padding:12px}
.modal.show{display:flex}
.modal-card{width:100%;max-width:560px;background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 30px 60px -40px rgba(15,23,42,.4);padding:14px}
.modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.modal-title{font-weight:800}
.xbtn{border:none;background:transparent;font-size:22px;cursor:pointer;color:#6b7280}
.form{display:grid;gap:10px}
label{display:grid;gap:6px;font-size:14px;color:#4b5563}
input,select,textarea{width:100%;padding:12px 14px;border:1px solid rgba(148,163,184,.45);border-radius:12px;font:inherit;font-size:16px;line-height:1.2;background:#fff}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row>.col{flex:1 1 180px}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.45);background:#fff;color:#111827;font-weight:700;cursor:pointer;font-size:16px}
.btn.primary{border:none;background:#007aff;color:#fff;box-shadow:0 20px 32px -20px rgba(0,122,255,.5)}

/* Multi-views */
.hidden{display:none}
.grid-week{display:grid;grid-template-columns:64px repeat(7,1fr);gap:10px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 24px 40px -32px rgba(15,23,42,.25);padding:10px}
.day-col{position:relative;border-left:1px dashed #e5e7eb;min-height:56px}
.grid-month{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 24px 40px -32px rgba(15,23,42,.25);padding:10px}
.month-cell{border:1px solid #e5e7eb;border-radius:10px;min-height:88px;padding:6px;display:grid;gap:4px}
.month-cell .d{font-size:12px;color:#6b7280}
.pill{display:inline-block;padding:2px 6px;border-radius:999px;background:#eef6ff;border:1px solid #c7ddff;font-size:12px}
.list-wrap{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 24px 40px -32px rgba(15,23,42,.25);padding:10px}
.list-item{display:flex;gap:10px;padding:10px;border-bottom:1px solid #eef2f7}
.list-item:last-child{border-bottom:none}

  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="header-inner">
      <div class="brand">Менеджер</div>
      <div class="views">
        <button class="chip active" data-view="day">День</button>
        <button class="chip" data-view="week">Неделя</button>
        <button class="chip" data-view="month">Месяц</button>
        <button class="chip" data-view="list">Список</button>
      </div>
    </div>
    <div class="days" id="daysScroller"></div>
  </header>

  <main>
    <div class="date-label" id="dateLabel"></div>

<!-- Day view -->
<div id="viewDayWrap" class="grid">
  <div class="hours" id="hoursCol"></div>
  <div class="lane" id="lane"></div>
</div>

<!-- Week view -->
<div id="viewWeekWrap" class="grid-week hidden">
  <div class="hours" id="hoursColW"></div>
  <div class="day-col" id="w0"></div>
  <div class="day-col" id="w1"></div>
  <div class="day-col" id="w2"></div>
  <div class="day-col" id="w3"></div>
  <div class="day-col" id="w4"></div>
  <div class="day-col" id="w5"></div>
  <div class="day-col" id="w6"></div>
</div>

<!-- Month view -->
<div id="viewMonthWrap" class="grid-month hidden"></div>

<!-- List view -->
<div id="viewListWrap" class="list-wrap hidden"><div id="listBody"></div></div>
  </main>

  <nav class="bottom">
    <div class="tabs">
      <div class="tab active"><div>📒</div><div>Записи</div></div>
      <div class="tab"><div>📆</div><div>График</div></div>
      <div class="tab"><div>🧭</div><div>Управление</div></div>
      <div class="tab"><div>⚙️</div><div>Настройки</div></div>
    </div>
  </nav>
</div>

<div class="modal" id="modalAdd">
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title">Новая запись</div>
      <button class="xbtn" id="closeAdd">×</button>
    </div>
    <div class="form">
      <div class="row">
        <div class="col"><label>Имя клиента
          <input id="abName" type="text" placeholder="Иван Иванов" required>
        </label></div>
        <div class="col"><label>Телефон
          <input id="abPhone" type="tel" placeholder="+375 .." required>
        </label></div>
      </div>
      <div class="row">
        <div class="col"><label>Услуга
          <select id="abService" required>
            <option value="" disabled selected>Выберите услугу…</option>
          </select>
        </label></div>
        <div class="col"><label>Мастер
          <select id="abMaster" required>
            <option value="" disabled selected>Все мастера</option>
          </select>
        </label></div>
      </div>
      <div class="row">
        <div class="col"><label>Дата
          <input id="abDate" type="date" required>
        </label></div>
        <div class="col"><label>Время
          <select id="abTime" required>
            <option value="" disabled selected>Сначала выберите дату</option>
          </select>
        </label></div>
      </div>
      <label>Комментарий
        <textarea id="abNotes" placeholder="Пожелания для мастера (необязательно)"></textarea>
      </label>
      <div class="actions">
        <button class="btn" id="abCancel" type="button">Отмена</button>
        <button class="btn primary" id="abSave" type="button">Создать</button>
      </div>
    </div>
  </div>
</div>

<button class="fab" id="fabAdd" title="Добавить запись">+</button>

<script>
(function(){
  async function ensureTgAuth(){ try{ const tg=window.Telegram&&window.Telegram.WebApp; if(!tg||!tg.initData||tg.initData.length<10) return; await fetch('/auth/telegram',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({initData:tg.initData})}); }catch(e){} }
  try{ const tg=window.Telegram&&window.Telegram.WebApp; if(tg){ tg.ready&&tg.ready(); tg.expand&&tg.expand(); } }catch{}
  ensureTgAuth();

  let cursor = new Date(); // selected anchor day
  let currentView = 'day';
  const hours=[...Array(12)].map((_,i)=> i+9); // 09..20

  // Elements
  const daysScroller=document.getElementById('daysScroller');
  const dateLabel=document.getElementById('dateLabel');
  const hoursCol=document.getElementById('hoursCol');
  const lane=document.getElementById('lane');
  const hoursColW=document.getElementById('hoursColW');
  const weekCols=[...Array(7)].map((_,i)=>document.getElementById('w'+i));
  const monthWrap=document.getElementById('viewMonthWrap');
  const listBody=document.getElementById('listBody');
  const dayWrap=document.getElementById('viewDayWrap');
  const weekWrap=document.getElementById('viewWeekWrap');
  const listWrap=document.getElementById('viewListWrap');

  // Modal elements
  const modal = document.getElementById('modalAdd');
  const openFab = document.getElementById('fabAdd');
  const closeBtn = document.getElementById('closeAdd');
  const cancelBtn = document.getElementById('abCancel');
  const saveBtn = document.getElementById('abSave');
  const fName = document.getElementById('abName');
  const fPhone = document.getElementById('abPhone');
  const fService = document.getElementById('abService');
  const fMaster = document.getElementById('abMaster');
  const fDate = document.getElementById('abDate');
  const fTime = document.getElementById('abTime');
  const fNotes = document.getElementById('abNotes');

  function ymd(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function addMonths(d,n){ const x=new Date(d); x.setMonth(x.getMonth()+n); return x; }
  function startOfWeek(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; }
  function toMin(t){ const [h,m]=String(t||'00:00').split(':').map(Number); return h*60+m; }

  function setView(v){
    currentView=v;
    document.querySelectorAll('.views .chip').forEach(c=>c.classList.toggle('active', c.dataset.view===v));
    dayWrap.classList.toggle('hidden', v!=='day');
    weekWrap.classList.toggle('hidden', v!=='week');
    monthWrap.classList.toggle('hidden', v!=='month');
    listWrap.classList.toggle('hidden', v!=='list');
    update();
  }
  document.querySelectorAll('.views .chip').forEach(c=>c.addEventListener('click',()=>setView(c.dataset.view)));

  function renderHours(container){ container.innerHTML=''; hours.forEach(h=>{ const c=document.createElement('div'); c.className='hcell'; c.textContent=String(h).padStart(2,'0')+':00'; container.appendChild(c); }); }

  function renderDaysStrip(){
    daysScroller.innerHTML='';
    for(let i=-3;i<=3;i++){
      const d=addDays(cursor,i); const el=document.createElement('div'); el.className='day';
      const dow=d.toLocaleDateString('ru-RU',{weekday:'short'}); const num=d.getDate(); const mon=d.toLocaleDateString('ru-RU',{month:'short'});
      el.innerHTML=`<div class='dow'>${dow}</div><div class='num'>${num} ${mon}</div>`;
      if(i===0) el.classList.add('active');
      el.addEventListener('click',()=>{ cursor=d; update(); });
      daysScroller.appendChild(el);
    }
  }

  function renderTitle(){
    const opt = currentView==='week' ? { day:'numeric', month:'long' } : currentView==='month' ? { month:'long', year:'numeric' } : { weekday:'long', day:'numeric', month:'long', year:'numeric' };
    dateLabel.textContent = 'Выбрано: ' + cursor.toLocaleDateString('ru-RU', opt);
  }

  async function fetchBookings(from,to){
    const r=await fetch(`/api/bookings?from=${from}&to=${to}`);
    return r.ok?await r.json():[];
  }

  function renderDay(bookings){
    lane.innerHTML=''; renderHours(hoursCol); lane.style.minHeight=(hours.length*56)+'px';
    const perMin=56/60;
    bookings.forEach(b=>{
      const top = Math.max(0,(toMin(b.startTime)-(9*60))*perMin);
      const dur = Number(b.duration||b.serviceDuration||30);
      const h = Math.max(36, Math.round(dur*perMin));
      const ev=document.createElement('div'); ev.className='event'; ev.style.top=top+'px'; ev.style.height=h+'px';
      ev.innerHTML = `<div class='t'>${b.startTime} • ${b.clientName||''}</div><div class='m'>${b.serviceName||''} · ${b.masterId||''}</div>`;
      lane.appendChild(ev);
    });
  }

  function renderWeek(weekBookings){
    weekCols.forEach(c=>c.innerHTML=''); renderHours(hoursColW); const perMin=56/60; const wkStart=startOfWeek(cursor);
    const map = new Map();
    for(const b of weekBookings){ if(!map.has(b.date)) map.set(b.date, []); map.get(b.date).push(b); }
    for(let i=0;i<7;i++){
      const d=addDays(wkStart,i); const key=ymd(d); const col=weekCols[i]; col.style.minHeight=(hours.length*56)+'px';
      const list=map.get(key)||[];
      list.forEach(b=>{
        const top = Math.max(0,(toMin(b.startTime)-(9*60))*perMin);
        const dur = Number(b.duration||b.serviceDuration||30);
        const h = Math.max(32, Math.round(dur*perMin));
        const ev=document.createElement('div'); ev.className='event'; ev.style.top=top+'px'; ev.style.height=h+'px';
        ev.innerHTML = `<div class='t'>${b.startTime}</div><div class='m'>${b.clientName||''}</div>`;
        col.appendChild(ev);
      });
    }
  }

  function renderMonth(monthBookings){
    monthWrap.innerHTML='';
    const first=new Date(cursor.getFullYear(), cursor.getMonth(), 1);
    const start = startOfWeek(first);
    for(let i=0;i<42;i++){
      const d=addDays(start,i); const cell=document.createElement('div'); cell.className='month-cell';
      cell.innerHTML = `<div class="d">${d.getDate()}</div>`;
      const key=ymd(d); const items=monthBookings.filter(b=>b.date===key);
      if(items.length){ cell.innerHTML += `<div class="pill">${items.length} запись(и)</div>`; }
      monthWrap.appendChild(cell);
    }
  }

  function renderList(list){
    listBody.innerHTML='';
    list.sort((a,b)=> (a.date.localeCompare(b.date)) || (a.startTime||'').localeCompare(b.startTime||''));
    for(const b of list){
      const el=document.createElement('div'); el.className='list-item';
      el.innerHTML = `<div style="min-width:86px"><b>${b.date}</b><div class='muted'>${b.startTime}</div></div>
      <div style="flex:1 1 auto"><div><b>${b.clientName||''}</b></div><div class='muted'>${b.serviceName||''}${b.masterId?` · ${b.masterId}`:''}</div></div>`;
      listBody.appendChild(el);
    }
  }

  async function update(){
    renderDaysStrip(); renderTitle();
    if(currentView==='day'){
      const from=ymd(cursor); const list = await fetchBookings(from,from); renderDay(list);
    } else if(currentView==='week'){
      const start = startOfWeek(cursor); const from=ymd(start); const to=ymd(addDays(start,6)); const list=await fetchBookings(from,to); renderWeek(list);
    } else if(currentView==='month'){
      const first=new Date(cursor.getFullYear(), cursor.getMonth(), 1); const last=new Date(cursor.getFullYear(), cursor.getMonth()+1, 0);
      const from=ymd(first); const to=ymd(last); const list=await fetchBookings(from,to); renderMonth(list);
    } else {
      const from=ymd(addDays(cursor,-14)); const to=ymd(addDays(cursor,14)); const list=await fetchBookings(from,to); renderList(list);
    }
  }

  // ==== Modal logic ====
  function openModal(){ modal.classList.add('show'); fDate.value = ymd(cursor); fTime.innerHTML='<option value=\"\" disabled selected>Загружаю слоты…</option>'; ensureRefs().then(loadAvailability); }
  function closeModal(){ modal.classList.remove('show'); }
  openFab.addEventListener('click', openModal);
  closeBtn.addEventListener('click', closeModal);
  cancelBtn.addEventListener('click', closeModal);

  // Load services & masters once
  let cachedServices=[]; let cachedMasters=[];
  async function ensureRefs(){
    if(!cachedServices.length){
      const r=await fetch('/api/services'); cachedServices = r.ok ? await r.json() : [];
      fService.innerHTML='<option value=\"\" disabled selected>Выберите услугу…</option>'+cachedServices.map(s=>`<option value=\"${s.id}\">${s.name} • ${s.duration} мин</option>`).join('');
    }
    if(!cachedMasters.length){
      const r=await fetch('/api/masters'); cachedMasters = r.ok ? await r.json() : [];
      fMaster.innerHTML='<option value=\"\" selected>Все мастера</option>'+cachedMasters.map(m=>`<option value=\"${m.id}\">${m.name}</option>`).join('');
    }
  }

  async function loadAvailability(){
    const date = fDate.value; const serviceId=fService.value; const masterId=fMaster.value||'';
    if(!date || !serviceId){ fTime.innerHTML='<option value=\"\" disabled selected>Выберите услугу и дату</option>'; return; }
    const url = new URL('/api/availability', location.origin);
    url.searchParams.set('date', date); url.searchParams.set('serviceId', serviceId); if(masterId) url.searchParams.set('masterId', masterId);
    const r=await fetch(url); const j=r.ok?await r.json():{slots:[]};
    const slots = (j.slots||[]).filter(s=>s.available);
    if(!slots.length){ fTime.innerHTML='<option value=\"\" disabled selected>Нет доступных слотов</option>'; return; }
    fTime.innerHTML = '<option value=\"\" disabled selected>Выберите время…</option>' + slots.map(s=>`<option value=\"${s.startTime}\">${s.startTime}</option>`).join('');
  }
  fService.addEventListener('change', loadAvailability);
  fMaster.addEventListener('change', loadAvailability);
  fDate.addEventListener('change', loadAvailability);

  async function createBooking(){
    const payload = {
      clientName: fName.value.trim(),
      clientPhone: fPhone.value.trim(),
      serviceId: Number(fService.value),
      masterId: fMaster.value || null,
      date: fDate.value,
      startTime: fTime.value,
      notes: fNotes.value.trim()
    };
    if(!payload.clientName || !payload.clientPhone || !payload.serviceId || !payload.date || !payload.startTime){
      alert('Заполните обязательные поля'); return;
    }
    const res = await fetch('/api/bookings',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!res.ok){ const err=await res.json().catch(()=>({})); alert(err.error||'Не удалось создать запись'); return; }
    closeModal(); update();
  }
  saveBtn.addEventListener('click', createBooking);

  // Init
  update();
})();
</script>
</body>
</html>
EOF