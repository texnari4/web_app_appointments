<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Beauty Appointments — Панель администратора</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      color-scheme: light;
      font-family: 'SF Pro Display', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      margin: 0;
      background: #f4f6fb;
      color: #0f172a;
    }

    .app-shell {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding: 32px 28px;
      background: #ffffff;
      border-right: 1px solid rgba(209, 213, 219, 0.45);
      backdrop-filter: blur(14px);
    }

    .sidebar .brand {
      display: grid;
      gap: 6px;
    }

    .sidebar .brand span {
      font-size: 13px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #94a3b8;
    }

    .sidebar .brand strong {
      font-size: clamp(22px, 3vw, 26px);
      letter-spacing: -0.01em;
    }

    .sidebar-footer {
      margin-top: auto;
      display: grid;
      gap: 16px;
      font-size: 13px;
      color: #64748b;
    }

    main {
      padding: 40px;
      display: grid;
      gap: 28px;
      align-content: start;
    }

    .page-head {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 24px;
    }

    .page-head h1 {
      margin: 0;
      font-size: clamp(30px, 4vw, 40px);
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .page-head p {
      margin: 4px 0 0;
      color: #64748b;
      font-size: 15px;
    }

    .page-head .status-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.01em;
      background: #e7ecf7;
      color: #0f172a;
    }

    h1 {
      margin: 0;
      font-size: clamp(28px, 4vw, 36px);
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(14px);
      border-radius: 20px;
      padding: 24px 26px;
      box-shadow: 0 35px 60px -40px rgba(15, 23, 42, 0.35);
      border: 1px solid rgba(209, 213, 219, 0.45);
    }

    .auth-card {
      display: grid;
      gap: 14px;
    }

    /* Make inner Access panel look flat inside Admin tab */
    .tab-panel .auth-card {
      background: transparent;
      border: 0;
      box-shadow: none;
      padding: 0;
      backdrop-filter: none;
      border-radius: 0;
    }

    .auth-card p {
      margin: 0;
      font-size: 15px;
      color: #4b5563;
    }

    .auth-card small {
      color: #6b7280;
    }

    .auth-dev {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
      margin-top: 8px;
    }

    .auth-dev label {
      display: grid;
      gap: 6px;
      font-size: 13px;
      color: #475569;
    }

    nav.tabs {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    nav.tabs button {
      border: none;
      border-radius: 12px;
      padding: 11px 18px;
      font-size: 15px;
      font-weight: 600;
      background: #e7ecf7;
      color: #0f172a;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
      justify-content: flex-start;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    nav.tabs button.active {
      background: linear-gradient(130deg, #5ec5ff, #007aff);
      color: #fff;
      box-shadow: 0 18px 32px -24px rgba(0, 122, 255, 0.45);
    }

    nav.tabs button:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 28px -22px rgba(15, 23, 42, 0.35);
    }

    .tab-panel {
      display: none;
      gap: 24px;
    }

    .tab-panel.active {
      display: grid;
    }

    .tab-wrapper {
      display: grid;
      gap: 28px;
    }

    .panel-grid,
    .cards-stack {
      display: grid;
      gap: 18px;
    }

    .panel-grid.two {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      align-items: start;
    }

    .info-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 18px;
      padding: 20px 22px;
      border: 1px solid rgba(209, 213, 219, 0.4);
      box-shadow: 0 24px 44px -32px rgba(15, 23, 42, 0.25);
      display: grid;
      gap: 10px;
    }

    .info-card h3 {
      margin: 0;
      font-size: 18px;
    }

    .info-card p {
      margin: 0;
      color: #475569;
      font-size: 14px;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .toggle-row {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #475569;
    }

    .token-output {
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(148, 163, 184, 0.12);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      font-size: 13px;
      color: #0f172a;
      word-break: break-all;
    }

    .metrics-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 8px;
    }

    .metrics-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #475569;
      font-size: 14px;
    }

    .metrics-list strong {
      font-size: 18px;
      color: #0f172a;
      letter-spacing: -0.01em;
    }

    .schedule-board {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 320px;
      gap: 20px;
      align-items: start;
    }

    .schedule-calendar {
      min-height: 320px;
      border-radius: 18px;
      border: 1px solid rgba(209, 213, 219, 0.4);
      background: rgba(255, 255, 255, 0.9);
      padding: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #475569;
      box-shadow: inset 0 0 0 1px rgba(226, 232, 240, 0.45);
    }

    .schedule-sidebar {
      display: grid;
      gap: 16px;
    }

    table.compact th,
    table.compact td {
      font-size: 13px;
    }

    .tags-cloud {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      color: #475569;
      font-size: 13px;
    }

    .tags-cloud span {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.16);
    }

    .chart-placeholder {
      min-height: 220px;
      border-radius: 16px;
      border: 1px dashed rgba(148, 163, 184, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 18px;
      color: #475569;
    }

    .log-view {
      white-space: pre-wrap;
      background: #0f172a;
      color: #e5e7eb;
      padding: 14px 16px;
      border-radius: 12px;
      max-height: 280px;
      overflow: auto;
      font-size: 13px;
    }

    .feature-list {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 6px;
      color: #475569;
      font-size: 14px;
    }

    .form-grid {
      display: grid;
      gap: 16px;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      gap: 12px;
    }

    .filters-row label {
      display: grid;
      gap: 6px;
      font-size: 13px;
      color: #475569;
    }

    .section-header {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .section-header h2 {
      margin: 0;
      font-size: 22px;
    }

    .form-grid label {
      display: grid;
      gap: 6px;
      font-size: 14px;
      color: #4b5563;
    }

    input,
    textarea,
    select {
      border: 1px solid rgba(148, 163, 184, 0.45);
      border-radius: 12px;
      padding: 11px 14px;
      font-size: 14px;
      font-family: inherit;
      background: rgba(255, 255, 255, 0.96);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: rgba(0, 122, 255, 0.9);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.18);
      background: #fff;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    button.primary-btn,
    button.secondary-btn,
    button.danger-btn {
      cursor: pointer;
      border: none;
      border-radius: 12px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }

    button.primary-btn:hover,
    button.secondary-btn:hover,
    button.danger-btn:hover {
      transform: translateY(-1px);
    }

    .primary-btn {
      background: linear-gradient(135deg, #5ec5ff, #007aff);
      color: #fff;
      box-shadow: 0 18px 28px -20px rgba(0, 122, 255, 0.45);
    }

    .secondary-btn {
      background: #f3f6fc;
      color: #0f172a;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .danger-btn {
      background: linear-gradient(135deg, #ff9eb5, #ff6b81);
      color: #fff;
      box-shadow: 0 16px 26px -22px rgba(255, 107, 129, 0.45);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 14px;
    }

    th,
    td {
      border-bottom: 1px solid rgba(226, 232, 240, 0.9);
      padding: 12px 10px;
      text-align: left;
      vertical-align: top;
    }

    thead th {
      background: #f8f9fc;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 12px;
      font-weight: 600;
      color: #7b8395;
    }

    tbody tr:hover {
      background: rgba(94, 197, 255, 0.06);
    }

    td[contenteditable="true"] {
      border-radius: 6px;
      min-width: 120px;
      outline: none;
    }

    td[contenteditable="true"]:focus {
      background: rgba(94, 197, 255, 0.1);
      box-shadow: inset 0 0 0 2px rgba(0, 122, 255, 0.35);
    }

    .table-actions {
      width: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.02em;
      background: #e2e8f0;
      color: #0f172a;
    }

    .status-badge::before {
      content: '';
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .status-pending {
      background: rgba(59, 130, 246, 0.16);
      color: #1d4ed8;
    }

    .status-confirmed {
      background: rgba(34, 197, 94, 0.18);
      color: #047857;
    }

    .status-cancelled {
      background: rgba(248, 113, 113, 0.18);
      color: #b91c1c;
    }

    .empty-row td {
      text-align: center;
      color: #94a3b8;
      font-style: italic;
    }

    .muted {
      color: #64748b;
      font-size: 13px;
    }

    .warning-card {
      margin-top: 16px;
      padding: 14px 16px;
      border-radius: 12px;
      background: rgba(255, 237, 213, 0.75);
      border: 1px solid rgba(251, 191, 36, 0.45);
      color: #92400e;
      font-size: 14px;
    }

    .banner {
      position: fixed;
      bottom: 22px;
      right: 22px;
      padding: 14px 20px;
      border-radius: 12px;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #34c759, #28b24a);
      box-shadow: 0 22px 38px -26px rgba(40, 178, 74, 0.6);
      opacity: 0;
      pointer-events: none;
      transform: translateY(18px);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .banner.show {
      opacity: 1;
      transform: translateY(0);
    }

    .banner.error {
      background: linear-gradient(135deg, #ff5f5f, #f43f5e);
      box-shadow: 0 22px 38px -26px rgba(244, 63, 94, 0.55);
    }

    /* Icon buttons for compact actions */
  .icon-btn { display:inline-flex; align-items:center; justify-content:center; gap:6px; padding:8px; width:36px; height:36px; border-radius:10px; border:1px solid rgba(148,163,184,.35); background:#f3f6fc; cursor:pointer }
  .icon-btn.primary { background: linear-gradient(135deg, #5ec5ff, #007aff); color:#fff; border-color: transparent }
  .icon-btn.danger  { background: linear-gradient(135deg, #ff9eb5, #ff6b81); color:#fff; border-color: transparent }
  .icon-btn svg { width:18px; height:18px }

    @media (max-width: 1200px) {
      .app-shell {
        grid-template-columns: 240px 1fr;
      }

      main {
        padding: 32px;
      }
    }

    @media (max-width: 960px) {
      .app-shell {
        grid-template-columns: 1fr;
      }

      .sidebar {
        position: sticky;
        top: 0;
        z-index: 12;
        flex-direction: row;
        align-items: center;
        gap: 18px;
        padding: 18px 22px;
        border-right: none;
        border-bottom: 1px solid rgba(209, 213, 219, 0.45);
        overflow-x: auto;
      }

      .sidebar .brand {
        min-width: 180px;
      }

      nav.tabs {
        flex-direction: row;
        gap: 8px;
      }

      nav.tabs button {
        white-space: nowrap;
      }

      main {
        padding: 24px;
      }

      section {
        padding: 20px;
      }

      .table-actions {
        flex-direction: column;
        width: auto;
      }

      .schedule-board {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="brand">
        <span>Beauty appointments</span>
        <strong>Админ-панель</strong>
      </div>
      <nav class="tabs">
        <button data-tab="bookings" class="active">Записи</button>
        <button data-tab="masters">Мастера</button>
        <button data-tab="schedules">Графики</button>
        <button data-tab="services">Услуги</button>
        <button data-tab="clients">Клиенты и аналитика</button>
        <button data-tab="backup">Резервное копирование</button>
        <button data-tab="integrations">Интеграции</button>
        <button data-tab="admins">Админ</button>
        <button data-tab="status">Status</button>
      </nav>
      <div class="sidebar-footer">
        <div>Разделы настраиваются под роли: owner → admin → manager → master.</div>
        <div class="pill" id="sidebarActiveRole">Роль: —</div>
      </div>
    </aside>
    <main>
      <header class="page-head">
        <div>
          <h1>Панель администратора</h1>
          <p>Управляйте расписанием салона, клиентами и интеграциями из одной точки.</p>
        </div>
        <div class="status-pills">
          <span class="pill" id="pillBookings">Записи • —</span>
          <span class="pill" id="pillMasters">Мастера • —</span>
          <span class="pill" id="pillStatus">Status • —</span>
        </div>
      </header>

      <div class="tab-wrapper">

    <section class="tab-panel active" data-tab-panel="bookings">
      <div class="section-header">
        <h2>Записи клиентов</h2>
        <div class="filters-row">
          <label>
            Статус
            <select id="bookingStatusFilter">
              <option value="all">Все</option>
              <option value="pending" selected>В ожидании</option>
              <option value="confirmed">Подтверждённые</option>
              <option value="cancelled">Отменённые</option>
            </select>
          </label>
          <label>
            Мастер
            <select id="bookingMasterFilter">
              <option value="">Все мастера</option>
            </select>
          </label>
          <label>
            Услуга
            <select id="bookingServiceFilter">
              <option value="">Все услуги</option>
            </select>
          </label>
          <label>
            Источник
            <select id="bookingSourceFilter">
              <option value="">Любой</option>
              <option value="web">Web</option>
              <option value="tg">Telegram</option>
              <option value="direct">Direct link</option>
            </select>
          </label>
          <label>
            С даты
            <input type="date" id="bookingDateFrom" />
          </label>
          <label>
            По дату
            <input type="date" id="bookingDateTo" />
          </label>
          <label>
            Поиск
            <input type="search" id="bookingSearchInput" placeholder="Имя или телефон" />
          </label>
        </div>
      </div>
      <div class="button-row" style="margin-bottom:12px">
        <button type="button" class="primary-btn" id="bookingCreateBtn">Создать запись</button>
        <button type="button" class="secondary-btn" id="bookingMassConfirm">Массово подтвердить</button>
        <button type="button" class="secondary-btn" id="bookingMassCancel">Массово отменить</button>
        <button type="button" class="secondary-btn" id="bookingExportBtn">Экспорт</button>
      </div>
      <div class="warning-card" id="bookingsWarning" hidden>
        Добавьте свой Telegram ID в список администраторов, чтобы подтверждать и отменять записи.
      </div>
      <section class="info-card">
        <h3>Умные подсказки</h3>
        <ul class="feature-list">
          <li>Свободные ближайшие окна подсвечиваются при выборе мастера.</li>
          <li>Пересечения с графиком и перерывами выделяются до сохранения.</li>
          <li>Быстрые действия открывают диалог с клиентом и историю визитов.</li>
        </ul>
      </section>
      <table id="bookingsTable">
        <thead>
          <tr>
            <th>Время</th>
            <th>Клиент</th>
            <th>Услуга</th>
            <th>Мастер</th>
            <th>Статус</th>
            <th class="table-actions">Действия</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="tab-panel" data-tab-panel="masters">
  <div class="form-grid">
    <div>
      <h2>Добавить мастера</h2>
      <form id="masterForm" class="form-grid">
        <label>
          Имя
          <input type="text" name="name" required placeholder="Например: Анна Петрова" />
        </label>
        <label>
          Специальности (через запятую)
          <input type="text" name="specialties" placeholder="бровист, визажист" />
        </label>
        <label>
          Фото (URL)
          <input type="url" name="photoUrl" placeholder="https://…/photo.jpg" />
        </label>
        <label>
          Описание
          <textarea name="description" placeholder="Кратко о мастере"></textarea>
        </label>

        <fieldset style="border:none;padding:0;margin:0;display:grid;gap:12px">
          <legend class="muted" style="margin-bottom:4px">Расписание</legend>
          <label>
            Тип расписания
            <select name="scheduleType">
              <option value="weekly" selected>По дням недели</option>
              <option value="shift">Смены (2/2 и т.п.)</option>
            </select>
          </label>

          <div data-schedule="weekly" class="form-grid">
            <label>Дни недели
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <label><input type="checkbox" name="weeklyDays" value="1" /> Пн</label>
                <label><input type="checkbox" name="weeklyDays" value="2" /> Вт</label>
                <label><input type="checkbox" name="weeklyDays" value="3" /> Ср</label>
                <label><input type="checkbox" name="weeklyDays" value="4" /> Чт</label>
                <label><input type="checkbox" name="weeklyDays" value="5" /> Пт</label>
                <label><input type="checkbox" name="weeklyDays" value="6" /> Сб</label>
                <label><input type="checkbox" name="weeklyDays" value="0" /> Вс</label>
              </div>
            </label>
            <label>Начало <input type="time" name="weeklyStart" value="10:00" /></label>
            <label>Конец <input type="time" name="weeklyEnd" value="19:00" /></label>
          </div>

          <div data-schedule="shift" class="form-grid" style="display:none">
            <label>Смена: рабочих дней
              <input type="number" name="shiftWork" min="1" value="2" />
            </label>
            <label>Смена: выходных дней
              <input type="number" name="shiftRest" min="1" value="2" />
            </label>
            <label>Опорная дата (начало рабочей смены)
              <input type="date" name="shiftAnchor" />
            </label>
            <label>Начало <input type="time" name="shiftStart" value="10:00" /></label>
            <label>Конец <input type="time" name="shiftEnd" value="19:00" /></label>
          </div>
        </fieldset>

      <label>
        Группа услуг
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
       <select id="masterGroupPicker"></select>
       <button type="button" class="secondary-btn" id="masterGroupAdd" title="Добавить все услуги выбранной группы">Добавить группу</button>
       </div>
       <small class="muted">При добавлении группы все услуги из неё добавятся в список ниже</small>
      </label>

        <label>
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <span>Услуги мастера</span>
            <span style="display:inline-flex;gap:8px;align-items:center">
              <select id="masterServicesPicker"></select>
              <button type="button" class="secondary-btn" id="masterServicesAdd" title="Добавить выбранную из списка">Добавить</button>
              <button type="button" class="secondary-btn" id="masterServicesRemove" title="Удалить выбранные ниже">Удалить</button>
            </span>
          </div>
          <small class="muted">Список добавленных услуг</small>
          <select id="masterServicesChosen" multiple size="6"></select>
        </label>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button type="submit" class="primary-btn" id="masterSubmitBtn">Добавить мастера</button>
          <button type="button" class="secondary-btn" id="masterCancelEdit" style="display:none">Отмена</button>
        </div>
      </form>
    </div>
  </div>

  <h2>Список мастеров</h2>
  <table id="mastersTable">
    <thead>
      <tr>
        <th>Фото</th>
        <th>Имя</th>
        <th>Спец-ть</th>
        <th>Описание</th>
        <th>Расписание</th>
        <th>Услуги</th>
        <th class="table-actions">Действия</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

    <section class="tab-panel" data-tab-panel="schedules">
      <div class="section-header">
        <h2>Графики мастеров</h2>
        <div class="filters-row">
          <label>
            Режим
            <select id="scheduleViewSelect">
              <option value="day">День</option>
              <option value="week" selected>Неделя</option>
              <option value="month">Месяц</option>
              <option value="resource">Ресурсный</option>
            </select>
          </label>
          <label>
            Мастер
            <select id="scheduleMasterFilter">
              <option value="">Все мастера</option>
            </select>
          </label>
          <label>
            Диапазон
            <input type="date" id="scheduleFrom" />
          </label>
          <label>
            &nbsp;
            <input type="date" id="scheduleTo" />
          </label>
          <button type="button" class="secondary-btn" id="scheduleApply">Применить</button>
        </div>
      </div>

      <div class="panel-grid two">
        <section class="info-card">
          <h3>Статистика загрузки</h3>
          <ul class="metrics-list">
            <li><span>Рабочих слотов</span><strong id="metricsSlots">—</strong></li>
            <li><span>Свободных слотов</span><strong id="metricsFreeSlots">—</strong></li>
            <li><span>Конфликтов</span><strong id="metricsConflicts">—</strong></li>
          </ul>
          <button type="button" class="secondary-btn" id="scheduleTemplateBtn">Шаблоны расписаний</button>
        </section>

        <section class="info-card">
          <h3>Исключения и спец-дни</h3>
          <p class="muted">Добавляйте выходные, сокращённые смены и временные слоты. Все изменения логируются.</p>
          <button type="button" class="secondary-btn" id="scheduleAddException">Добавить исключение</button>
          <table class="compact" id="scheduleExceptionsTable">
            <thead>
              <tr>
                <th>Дата</th>
                <th>Мастер</th>
                <th>Комментарий</th>
              </tr>
            </thead>
            <tbody>
              <tr class="empty-row"><td colspan="3">Нет исключений</td></tr>
            </tbody>
          </table>
        </section>
      </div>

      <div class="schedule-board">
        <div class="schedule-calendar" id="scheduleCalendar">Календарь по мастерам появится здесь (неделя/месяц/ресурсный режимы).</div>
        <aside class="schedule-sidebar">
          <section class="info-card">
            <h3>Грядущие смены</h3>
            <ul class="muted" id="scheduleUpcoming">
              <li>—</li>
            </ul>
          </section>
          <section class="info-card">
            <h3>Проверка занятости</h3>
            <p class="muted">При конфликте слота система подсветит запись в «Записях» и предложит свободные альтернативы.</p>
            <button type="button" class="secondary-btn" id="scheduleCheckConflicts">Проверить конфликты</button>
          </section>
        </aside>
      </div>
    </section>
    <section class="tab-panel" data-tab-panel="services">
      <div class="section-header">
        <h2>Услуги и категории</h2>
        <p class="muted">Глобальный каталог услуг и персональные прайсы мастеров.</p>
      </div>

      <div class="panel-grid two">
        <section class="info-card">
          <h3>Добавить услугу</h3>
          <p>Создайте новую услугу, задайте длительность и стоимость. Назначить мастерам можно после сохранения.</p>
          <form id="serviceForm" class="form-grid">
            <label>
              Название
              <input type="text" name="name" placeholder="Например: SPA-массаж" required />
            </label>
            <label>
              Описание
              <textarea name="description" placeholder="Кратко опишите услугу" required></textarea>
            </label>
            <label>
              Цена (₽)
              <input type="number" name="price" min="0" step="1" required />
            </label>
            <label>
              Длительность (мин)
              <input type="number" name="duration" min="30" step="5" required />
            </label>
            <label>
              Категория
              <select name="groupId">
                <option value="">Без категории</option>
              </select>
            </label>
            <button type="submit" class="primary-btn">Добавить услугу</button>
          </form>
        </section>

        <section class="info-card">
          <h3>Категории услуг</h3>
          <p> Используйте категории, чтобы группировать услуги в клиентском каталоге и фильтрах мастеров.</p>
          <form id="groupForm" class="form-grid">
            <label>
              Название категории
              <input type="text" name="name" placeholder="Например: Косметология" required />
            </label>
            <button type="submit" class="secondary-btn">Создать категорию</button>
          </form>
          <table id="groupsTable" style="margin-top:12px">
            <thead>
              <tr>
                <th>Название</th>
                <th class="table-actions">Действия</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>
      </div>

      <div class="section-header" style="margin-top:12px;">
        <h2>Список услуг</h2>
        <label>
          Фильтр по категории
          <select id="groupFilter">
            <option value="">Все категории</option>
          </select>
        </label>
      </div>
      <table id="servicesTable">
        <thead>
          <tr>
            <th>Название</th>
            <th>Описание</th>
            <th>Цена, ₽</th>
            <th>Длительность</th>
            <th>Категория</th>
            <th class="table-actions">Действия</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="tab-panel" data-tab-panel="clients">
      <div class="section-header">
        <h2>Клиенты и аналитика</h2>
        <div class="filters-row">
          <label>
            Период
            <select id="analyticsPeriod">
              <option value="7d">Неделя</option>
              <option value="30d" selected>30 дней</option>
              <option value="90d">Квартал</option>
              <option value="365d">Год</option>
            </select>
          </label>
          <label>
            Мастер
            <select id="analyticsMasterFilter">
              <option value="">Все</option>
            </select>
          </label>
          <label>
            Услуга
            <select id="analyticsServiceFilter">
              <option value="">Все</option>
            </select>
          </label>
          <button type="button" class="secondary-btn" id="analyticsExportCsv">Экспорт CSV</button>
        </div>
      </div>

      <div class="panel-grid two">
        <section class="info-card">
          <h3>Основные показатели</h3>
          <ul class="metrics-list">
            <li><span>Записей</span><strong id="analyticsBookings">—</strong></li>
            <li><span>Новых клиентов</span><strong id="analyticsNewClients">—</strong></li>
            <li><span>Выручка</span><strong id="analyticsRevenue">—</strong></li>
          </ul>
        </section>
        <section class="info-card">
          <h3>Распределение</h3>
          <p class="muted">Популярные услуги, мастера и источники записей за выбранный период.</p>
          <div class="tags-cloud" id="analyticsDistribution">—</div>
        </section>
      </div>

      <section class="info-card">
        <h3>Список клиентов</h3>
        <p class="muted">Статусы, история визитов и LTV доступны на карточке клиента.</p>
        <table id="clientsTable">
          <thead>
            <tr>
              <th>Клиент</th>
              <th>Контакты</th>
              <th>Визиты</th>
              <th>LTV</th>
              <th>Последний визит</th>
              <th>Метки</th>
              <th class="table-actions">Действия</th>
            </tr>
          </thead>
          <tbody>
            <tr class="empty-row"><td colspan="7">Данные появятся после подключения /api/clients</td></tr>
          </tbody>
        </table>
      </section>

      <div class="panel-grid two">
        <section class="info-card">
          <h3>Аналитика по услугам</h3>
          <div class="chart-placeholder" id="analyticsServicesChart">Графики загрузки услуг появятся после настройки бэкенда.</div>
        </section>
        <section class="info-card">
          <h3>Retention и отмены</h3>
          <div class="chart-placeholder" id="analyticsRetentionChart">Кривые удержания и показатели отмен доступны в API аналитики.</div>
        </section>
      </div>
    </section>

    <section class="tab-panel" data-tab-panel="backup">
      <div class="section-header">
        <h2>Резервное копирование и синхронизация</h2>
        <p class="muted">Экспорт/импорт данных салона и обмен с Google Sheets.</p>
      </div>

      <div class="panel-grid two">
        <section class="info-card">
          <h3>ZIP архив</h3>
          <p>Снимите полную копию данных или восстановитесь из готового архива. Доступно только администраторам.</p>
          <div class="button-row">
            <button type="button" class="secondary-btn" id="gsExportBtn">Экспорт ZIP</button>
            <button type="button" class="primary-btn" id="gsImportBtn">Импорт ZIP</button>
          </div>
          <small class="muted">Последний бэкап: <span id="lastBackupAt">—</span></small>
        </section>

        <section class="info-card">
          <h3>Google Sheets</h3>
          <p>Синхронизируйте каталог услуг, мастеров и записи с Таблицами Google.</p>
          <div class="button-row">
            <button type="button" class="secondary-btn" id="gsCsvExportBtn" title="Выгрузить данные для Google Sheets">Экспорт в Sheets</button>
            <button type="button" class="primary-btn" id="gsCsvImportBtn" title="Загрузить данные из Google Sheets (CSV/ZIP)">Импорт из Sheets</button>
          </div>
          <small class="muted">При импорте локальные данные полностью перезаписываются.</small>
        </section>
      </div>

      <section class="info-card">
        <h3>История бэкапов</h3>
        <table id="backupHistoryTable" class="compact">
          <thead>
            <tr>
              <th>Дата</th>
              <th>Тип</th>
              <th>Статус</th>
            </tr>
          </thead>
          <tbody>
            <tr class="empty-row"><td colspan="3">Журнал появится после первого бэкапа</td></tr>
          </tbody>
        </table>
      </section>

      <section class="info-card">
        <h3>Журнал синхронизации</h3>
        <pre class="log-view" id="backupSyncLog">Подключите Google Sheets, чтобы видеть отчёт о синхронизации.</pre>
      </section>
    </section>

    <section class="tab-panel" data-tab-panel="integrations">
      <div class="section-header">
        <h2>Интеграции</h2>
        <p class="muted">Настройте обмен данными и уведомления с внешними сервисами.</p>
      </div>

      <div class="panel-grid two">
        <section class="info-card">
          <h3>Telegram</h3>
          <p>Уведомления для мастеров и клиентов, выдача токенов и рассылки через бота.</p>
          <label class="toggle-row">
            <input type="checkbox" id="toggleTelegram" />
            <span>Включить интеграцию</span>
          </label>
          <div class="button-row">
            <button type="button" class="secondary-btn" id="telegramBotSettings">Настроить бота</button>
            <button type="button" class="secondary-btn" id="telegramBroadcast">Рассылка</button>
          </div>
          <small class="muted">Webhook: <code id="telegramWebhookUrl">—</code></small>
        </section>

        <section class="info-card">
          <h3>Google Sheets</h3>
          <p>Синхронизация с таблицами для аналитики и ручного редактирования данных.</p>
          <label class="toggle-row">
            <input type="checkbox" id="toggleSheets" />
            <span>Автосинхронизация каждые 15 минут</span>
          </label>
          <div class="button-row">
            <button type="button" class="secondary-btn" id="sheetsConnect">Подключить</button>
            <button type="button" class="secondary-btn" id="sheetsSyncNow">Синхронизировать сейчас</button>
          </div>
          <small class="muted">Последняя синхронизация: <span id="sheetsSyncedAt">—</span></small>
        </section>

        <section class="info-card">
          <h3>Google Calendar</h3>
          <p>Двусторонняя синхронизация расписаний мастеров и событий в календарях.</p>
          <label class="toggle-row">
            <input type="checkbox" id="toggleCalendar" />
            <span>Отправлять записи в календарь</span>
          </label>
          <div class="button-row">
            <button type="button" class="secondary-btn" id="calendarConnect">Подключить</button>
            <button type="button" class="secondary-btn" id="calendarSyncNow">Синхронизировать</button>
          </div>
          <small class="muted">Проверка учётных данных и прав доступа — через сервисный аккаунт.</small>
        </section>

        <section class="info-card">
          <h3>Webhook / API</h3>
          <p>Подключите CRM, CDP или аналитику через Webhook API.</p>
          <label class="toggle-row">
            <input type="checkbox" id="toggleWebhook" />
            <span>Активировать API</span>
          </label>
          <div class="form-grid" style="margin-top:8px">
            <label>
              URL Webhook
              <input type="url" id="webhookUrl" placeholder="https://example.com/webhook" />
            </label>
            <label>
              Секретный ключ
              <input type="text" id="webhookSecret" placeholder="******" />
            </label>
          </div>
          <button type="button" class="secondary-btn" id="webhookTest">Отправить тестовый запрос</button>
        </section>
      </div>
    </section>

    <section class="tab-panel" data-tab-panel="admins">
      <section class="auth-card" id="authCard">
        <h2>Доступ</h2>
        <p id="authStatus">Проверяю доступ…</p>
        <small>Панель доступна только администраторам, чьи Telegram ID добавлены в список. В мини‑приложении данные приходят автоматически.</small>
        <div class="auth-dev">
          <label>
            Telegram ID для локального доступа
            <input type="number" id="manualTelegramId" placeholder="Например: 486778995" />
          </label>
          <button type="button" class="secondary-btn" id="applyManualIdBtn">Сохранить</button>
          <button type="button" class="secondary-btn" id="clearManualIdBtn">Сбросить</button>
        </div>
      </section>
      <div class="panel-grid two">
        <section class="info-card">
          <h3>Токены и ссылки</h3>
          <p>Генерируйте доступы для кабинетов `/manager`, клиентских ссылок и интеграций API.</p>
          <div class="form-grid">
            <label>
              Тип токена
              <select id="tokenTypeSelect">
                <option value="manager">Менеджер</option>
                <option value="master">Мастер</option>
                <option value="client">Клиент</option>
                <option value="admin">Администратор</option>
                <option value="api">API</option>
              </select>
            </label>
            <label>
              Мастер / сущность
              <select id="tokenMasterSelect">
                <option value="">Не выбрано</option>
              </select>
            </label>
          </div>
          <div class="button-row">
            <button type="button" class="primary-btn" id="tokenGenerateBtn">Сгенерировать токен</button>
            <button type="button" class="secondary-btn" id="tokenDeactivateBtn">Деактивировать</button>
          </div>
          <div class="token-output" id="tokenOutput">—</div>
        </section>

        <section class="info-card">
          <h3>Аудит действий</h3>
          <p class="muted">Каждое изменение данных, импорт и выдача токенов фиксируются в журнале.</p>
          <div class="button-row">
            <button type="button" class="secondary-btn" id="auditRefresh">Обновить</button>
            <button type="button" class="secondary-btn" id="auditExport">Экспорт журнала</button>
          </div>
          <pre class="log-view" id="auditLog">Логи появятся после интеграции /api/audit.</pre>
        </section>
      </div>
      <div class="form-grid">
        <div>
          <h2>Добавить администратора</h2>
          <form id="adminForm" class="form-grid">
            <label>
              Telegram ID
              <input type="number" name="id" min="1" step="1" placeholder="Например: 123456789" required />
            </label>
            <label>
              Username (без @)
              <input type="text" name="username" placeholder="Например: beauty_manager" required />
            </label>
            <label>
              Отображаемое имя (необязательно)
              <input type="text" name="displayName" placeholder="Имя для списка" />
            </label>
            <label>
              Роль
              <select name="role">
                <option value="admin" selected>Администратор</option>
                <option value="owner">Владелец</option>
              </select>
            </label>
            <button type="submit" class="primary-btn">Добавить администратора</button>
          </form>
        </div>
      </div>
      <h2>Список администраторов</h2>
      <div class="warning-card" id="adminsWarning" hidden>
        Только владелец может добавлять и удалять администраторов.
      </div>
      <table id="adminsTable">
        <thead>
          <tr>
            <th>Telegram ID</th>
            <th>Username</th>
            <th>Имя</th>
            <th>Роль</th>
            <th class="table-actions">Действия</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="tab-panel" data-tab-panel="status">
      <h2>Состояние системы</h2>
      <div class="form-grid">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button type="button" class="secondary-btn" id="statusRefreshBtn">Проверить сейчас</button>
          <button type="button" class="secondary-btn" id="seedDemoBtn" title="Создать тестовые данные">Создать демо‑данные</button>
          <button type="button" class="secondary-btn" id="statusExportBtn" title="Экспорт ZIP бэкапа">Экспорт ZIP</button>
          <button type="button" class="primary-btn" id="statusImportBtn" title="Импорт ZIP бэкапа">Импорт ZIP</button>
        </div>
        <pre id="statusOutput" style="margin-top:12px; white-space:pre-wrap; background:#0f172a; color:#e5e7eb; padding:14px 16px; border-radius:12px; overflow:auto; max-height:240px;">—</pre>
      </div>

      <h3 style="margin-top:10px">Логи</h3>
      <div class="form-grid">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button type="button" class="secondary-btn" id="logsRefreshBtn">Обновить логи</button>
          <label style="display:inline-flex;gap:6px;align-items:center"><span class="muted">Показать</span>
            <select id="logsLimitSelect">
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="200">200</option>
            </select>
          </label>
        </div>
        <pre id="logsOutput" style="white-space:pre-wrap; background:#0f172a; color:#e5e7eb; padding:14px 16px; border-radius:12px; overflow:auto; max-height:320px;">—</pre>
      </div>
    </section>
      </div>
    </main>
  </div>

  <div class="banner" id="banner" hidden></div>

  <!--
    [REMOVED unintended plaintext block with Google Sheets helpers]
  -->

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const state = {
        services: [],
        groups: [],
        bookings: [],
        admins: [],
  masters: [],
        filterGroupId: null,
        bookingStatusFilter: 'pending',
        activeTab: 'bookings'
      };

      const servicesTableBody = document.querySelector('#servicesTable tbody');
      const groupsTableBody = document.querySelector('#groupsTable tbody');
      const bookingsTableBody = document.querySelector('#bookingsTable tbody');
      const adminsTableBody = document.querySelector('#adminsTable tbody');


      const mastersTableBody = document.querySelector('#mastersTable tbody');
const masterForm = document.getElementById('masterForm');
const bookingStatusFilter = document.getElementById('bookingStatusFilter');
      const groupFilter = document.getElementById('groupFilter');
      const adminForm = document.getElementById('adminForm');
      const serviceForm = document.getElementById('serviceForm');
      const groupForm = document.getElementById('groupForm');
      const serviceFormGroupSelect = serviceForm.querySelector('select[name="groupId"]');
      const banner = document.getElementById('banner');

      const scheduleMasterFilter = document.getElementById('scheduleMasterFilter');
      const scheduleViewSelect = document.getElementById('scheduleViewSelect');
      const scheduleApplyBtn = document.getElementById('scheduleApply');
      const analyticsMasterFilter = document.getElementById('analyticsMasterFilter');
      const analyticsServiceFilter = document.getElementById('analyticsServiceFilter');
      const analyticsExportCsv = document.getElementById('analyticsExportCsv');
      const bookingMasterFilter = document.getElementById('bookingMasterFilter');
      const bookingServiceFilter = document.getElementById('bookingServiceFilter');
      const bookingSourceFilter = document.getElementById('bookingSourceFilter');
      const bookingDateFrom = document.getElementById('bookingDateFrom');
      const bookingDateTo = document.getElementById('bookingDateTo');
      const bookingSearchInput = document.getElementById('bookingSearchInput');
      const bookingCreateBtn = document.getElementById('bookingCreateBtn');
      const bookingMassConfirmBtn = document.getElementById('bookingMassConfirm');
      const bookingMassCancelBtn = document.getElementById('bookingMassCancel');
      const bookingExportBtn = document.getElementById('bookingExportBtn');
      const pillBookings = document.getElementById('pillBookings');
      const pillMasters = document.getElementById('pillMasters');
      const pillStatus = document.getElementById('pillStatus');
      const sidebarActiveRole = document.getElementById('sidebarActiveRole');
      const lastBackupAt = document.getElementById('lastBackupAt');
      const tokenMasterSelect = document.getElementById('tokenMasterSelect');
      const tokenTypeSelect = document.getElementById('tokenTypeSelect');
      const tokenGenerateBtn = document.getElementById('tokenGenerateBtn');
      const tokenDeactivateBtn = document.getElementById('tokenDeactivateBtn');
      const tokenOutput = document.getElementById('tokenOutput');
      const auditRefreshBtn = document.getElementById('auditRefresh');
      const auditExportBtn = document.getElementById('auditExport');
      const auditLog = document.getElementById('auditLog');
      const scheduleTemplateBtn = document.getElementById('scheduleTemplateBtn');
      const scheduleAddExceptionBtn = document.getElementById('scheduleAddException');
      const scheduleCheckConflictsBtn = document.getElementById('scheduleCheckConflicts');
      const sheetsConnectBtn = document.getElementById('sheetsConnect');
      const sheetsSyncNowBtn = document.getElementById('sheetsSyncNow');
      const telegramBotSettingsBtn = document.getElementById('telegramBotSettings');
      const telegramBroadcastBtn = document.getElementById('telegramBroadcast');
      const calendarConnectBtn = document.getElementById('calendarConnect');
      const calendarSyncNowBtn = document.getElementById('calendarSyncNow');
      const webhookTestBtn = document.getElementById('webhookTest');


      const authStatus = document.getElementById('authStatus');
      const manualTelegramId = document.getElementById('manualTelegramId');
      const applyManualIdBtn = document.getElementById('applyManualIdBtn');
      const clearManualIdBtn = document.getElementById('clearManualIdBtn');
      const bookingsWarning = document.getElementById('bookingsWarning');
      const adminsWarning = document.getElementById('adminsWarning');
      const gsExportBtn = document.getElementById('gsExportBtn');
      const gsImportBtn = document.getElementById('gsImportBtn');
      const gsCsvExportBtn = document.getElementById('gsCsvExportBtn');
      const gsCsvImportBtn = document.getElementById('gsCsvImportBtn');
      const statusRefreshBtn = document.getElementById('statusRefreshBtn');
      const statusOutput = document.getElementById('statusOutput');
      const seedDemoBtn = document.getElementById('seedDemoBtn');
      const statusExportBtn = document.getElementById('statusExportBtn');
      const statusImportBtn = document.getElementById('statusImportBtn');
      const logsRefreshBtn = document.getElementById('logsRefreshBtn');
      const logsLimitSelect = document.getElementById('logsLimitSelect');
      const logsOutput = document.getElementById('logsOutput');

      const tabsNav = document.querySelectorAll('nav.tabs button');
      const tabPanels = document.querySelectorAll('.tab-panel');

      const AUTH_STORAGE_KEY = 'beauty_admin_telegram_id_v1';

      const authState = {
        telegramId: null,
        role: 'guest',
        admin: null,
        isAuthorized: false
      };

      const escapeHtml = (value = '') =>
        String(value).replace(/[&<>"']/g, (char) => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        })[char] || char);

      const EXCEL_EPOCH_MS = Date.UTC(1899, 11, 30);

      const toTimeLabel = (minutesTotal) => {
        const minutes = ((minutesTotal % (24 * 60)) + (24 * 60)) % (24 * 60);
        const hours = String(Math.floor(minutes / 60)).padStart(2, '0');
        const mins = String(minutes % 60).padStart(2, '0');
        return `${hours}:${mins}`;
      };

      const normalizeDateString = (value) => {
        if (value == null || value === '') return '';
        if (typeof value === 'number' && Number.isFinite(value)) {
          const date = new Date(EXCEL_EPOCH_MS + Math.round(value * 86400000));
          if (!Number.isFinite(date.getTime())) return '';
          return date.toISOString().slice(0, 10);
        }
        const text = String(value).trim();
        if (!text) return '';
        if (/^\d{4}-\d{2}-\d{2}$/.test(text)) return text;
        const numeric = Number(text);
        if (!Number.isNaN(numeric) && text !== '') {
          return normalizeDateString(numeric);
        }
        const parsed = Date.parse(text);
        if (!Number.isNaN(parsed)) {
          return new Date(parsed).toISOString().slice(0, 10);
        }
        return '';
      };

      const normalizeTimeString = (value) => {
        if (value == null || value === '') return '';
        if (typeof value === 'number' && Number.isFinite(value)) {
          const fractional = value % 1;
          const minutes = Math.round(((fractional < 0 ? fractional + 1 : fractional)) * 24 * 60);
          return toTimeLabel(minutes);
        }
        const text = String(value).trim();
        if (!text) return '';
        const match = text.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
        if (match) {
          const hours = String(Number(match[1]) % 24).padStart(2, '0');
          const minutes = String(Number(match[2]) % 60).padStart(2, '0');
          return `${hours}:${minutes}`;
        }
        const numeric = Number(text);
        if (!Number.isNaN(numeric) && text !== '') {
          return normalizeTimeString(numeric);
        }
        const parsed = Date.parse(text);
        if (!Number.isNaN(parsed)) {
          const date = new Date(parsed);
          const minutes = date.getUTCHours() * 60 + date.getUTCMinutes();
          return toTimeLabel(minutes);
        }
        return '';
      };

      const getBookingDateTime = (booking) => {
        const date = normalizeDateString(booking.date) || '';
        const time = normalizeTimeString(booking.startTime) || '';
        if (!date || !time) return null;
        const iso = `${date}T${time}:00`;
        const timestamp = Date.parse(iso);
        if (Number.isNaN(timestamp)) return null;
        return new Date(timestamp);
      };

      const showBanner = (message, type = 'success') => {
        banner.textContent = message;
        banner.classList.toggle('error', type === 'error');
        banner.classList.add('show');
        banner.hidden = false;
        setTimeout(() => {
          banner.classList.remove('show');
          setTimeout(() => {
            banner.hidden = true;
          }, 180);
        }, 2300);
      };

      const withAuthHeaders = (headers = {}) => {
        const result = { ...headers };
        if (authState.telegramId) {
          result['X-Telegram-Id'] = authState.telegramId;
        }
        return result;
      };

      const apiFetch = async (input, options = {}) => {
        const init = { ...options };
        init.headers = withAuthHeaders(init.headers || {});
        const response = await fetch(input, init);
        if (response.status === 401) {
          showBanner('Укажите Telegram ID администратора', 'error');
          updateAuthStatus();
        } else if (response.status === 403) {
          showBanner('Недостаточно прав для действия', 'error');
          updateAuthStatus();
        }
        return response;
      };

      const refreshStatus = async () => {
        try {
          const resp = await apiFetch('/api/health');
          if (!resp.ok) { await handleError(resp); return; }
          const data = await resp.json();
          statusOutput.textContent = JSON.stringify(data, null, 2);
          if (pillStatus) {
            const label = data?.status || (data?.ok ? 'OK' : '—');
            const version = data?.version ? ` v${data.version}` : '';
            pillStatus.textContent = `Status • ${label}${version}`;
          }
          if (lastBackupAt) {
            const last = data?.backup?.lastAt || data?.backup?.lastRunAt;
            lastBackupAt.textContent = last ? new Date(last).toLocaleString('ru-RU') : '—';
          }
        } catch (e) {
          console.error(e);
          statusOutput.textContent = 'Не удалось получить состояние системы';
          showBanner('Ошибка получения состояния системы', 'error');
        }
      };

      const refreshLogs = async () => {
        try {
          const limit = Number(logsLimitSelect?.value || 100);
          const resp = await apiFetch('/api/logs?limit=' + limit);
          if (!resp.ok) { await handleError(resp); return; }
          const data = await resp.json();
          logsOutput.textContent = (data.logs || [])
            .map(x => `[${x.time}] ${x.level || 'info'}:${x.type} ${x.message || ''}`)
            .join('\n') || '—';
        } catch (e) {
          console.error(e);
          logsOutput.textContent = 'Не удалось загрузить логи';
        }
      };

      const seedDemoData = async () => {
        if (!authState.isAuthorized) { showBanner('Нет прав', 'error'); return; }
        if (!confirm('Создать демо‑данные? Это добавит пример услуг, мастеров и записей.')) return;
        const resp = await apiFetch('/api/seed/demo', { method: 'POST' });
        if (!resp.ok) { await handleError(resp); return; }
        await refreshStatus();
        await refreshLogs();
        showBanner('Демо‑данные созданы');
      };

      const exportZip = async () => {
        if (!authState.isAuthorized) { showBanner('Нет прав', 'error'); return; }
        const resp = await apiFetch('/api/backup/export');
        if (!resp.ok) { await handleError(resp); return; }
        const blob = await resp.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = 'backup.zip';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(a.href);
        showBanner('Экспортирован ZIP архив');
        if (lastBackupAt) {
          lastBackupAt.textContent = new Date().toLocaleString('ru-RU');
        }
        refreshLogs();
      };

      const importZip = async () => {
        if (!authState.isAuthorized) { showBanner('Нет прав', 'error'); return; }
        const input = document.createElement('input');
        input.type = 'file'; input.accept = '.zip,application/zip';
        input.onchange = async () => {
          const file = input.files?.[0]; if (!file) return;
          const fd = new FormData(); fd.append('file', file);
          const resp = await apiFetch('/api/backup/import', { method: 'POST', body: fd });
          if (!resp.ok) { await handleError(resp); return; }
          await refreshStatus();
          await refreshLogs();
          showBanner('Импорт завершён');
          if (lastBackupAt) {
            lastBackupAt.textContent = new Date().toLocaleString('ru-RU');
          }
        };
        input.click();
      };
      const handleError = async (response) => {
        if (response.status === 401 || response.status === 403) {
          return;
        }
        let errorMessage = 'Что-то пошло не так';
        try {
          const payload = await response.json();
          if (payload?.error) {
            errorMessage = payload.error;
          }
        } catch (_) {}
        showBanner(errorMessage, 'error');
      };

      const detectTelegramId = () => {
        const telegram = window.Telegram?.WebApp;
        if (telegram?.initDataUnsafe?.user?.id) {
          return Number(telegram.initDataUnsafe.user.id);
        }
        const urlParams = new URLSearchParams(window.location.search);
        const paramId = Number(urlParams.get('tg_id'));
        if (Number.isFinite(paramId) && paramId > 0) {
          return paramId;
        }
        const storedId = Number(localStorage.getItem(AUTH_STORAGE_KEY));
        if (Number.isFinite(storedId) && storedId > 0) {
          return storedId;
        }
        return null;
      };

      const setTelegramId = (value) => {
        if (value == null) {
          authState.telegramId = null;
          localStorage.removeItem(AUTH_STORAGE_KEY);
        } else {
          const numeric = Number(value);
          if (!Number.isFinite(numeric) || numeric <= 0) {
            showBanner('Введите корректный Telegram ID', 'error');
            return;
          }
          authState.telegramId = numeric;
          localStorage.setItem(AUTH_STORAGE_KEY, String(numeric));
        }
        updateAuthStatus();
        refreshAccess();
      };

      const updateAuthStatus = () => {
        if (!authState.telegramId) {
          authStatus.textContent = 'Telegram ID не определён. Введите ID вручную или откройте панель из Telegram.';
          manualTelegramId.value = '';
          bookingsWarning.hidden = true;
          adminsWarning.hidden = true;
          if (sidebarActiveRole) {
            sidebarActiveRole.textContent = 'Роль: —';
          }
          return;
        }

        manualTelegramId.value = authState.telegramId;
        const roleLabelMap = { owner: 'Владелец', admin: 'Администратор', hostess: 'Хостес', hostes: 'Хостес', manager: 'Менеджер', master: 'Мастер' };
        const roleLabel = roleLabelMap[authState.role] || 'Гость';
        if (authState.isAuthorized) {
          authStatus.textContent = `Доступ разрешён (${roleLabel}). Telegram ID: ${authState.telegramId}`;
        } else {
          authStatus.textContent = `Telegram ID ${authState.telegramId} не найден в списке администраторов.`;
        }

        if (sidebarActiveRole) {
          sidebarActiveRole.textContent = `Роль: ${authState.isAuthorized ? roleLabel : '—'}`;
        }

        bookingsWarning.hidden = authState.isAuthorized;
        adminsWarning.hidden = authState.role === 'owner' || !authState.isAuthorized;
        adminForm.querySelectorAll('input, select, button').forEach((el) => {
          el.disabled = !(authState.role === 'owner');
        });
      };

      const updateDashboardCounters = () => {
        if (pillBookings) {
          const total = state.bookings.length;
          const pending = state.bookings.filter((item) => item.status === 'pending').length;
          pillBookings.textContent = total
            ? `Записи • ${total} (${pending} в ожидании)`
            : 'Записи • —';
        }
        if (pillMasters) {
          const totalMasters = state.masters.length;
          pillMasters.textContent = totalMasters ? `Мастера • ${totalMasters}` : 'Мастера • —';
        }
      };

      const refreshAccess = async () => {
        if (!authState.telegramId) {
          authState.isAuthorized = false;
          authState.role = 'guest';
          authState.admin = null;
          updateAuthStatus();
          renderServicesTable();
          renderGroupsTable();
          renderBookingsTable();
          renderAdminsTable();
          return;
        }

        try {
          const response = await apiFetch('/api/admins/me');
          if (!response.ok) {
            authState.isAuthorized = false;
            authState.role = 'guest';
            authState.admin = null;
            updateAuthStatus();
            return;
          }
          const data = await response.json();
          authState.isAuthorized = Boolean(data.authenticated);
          authState.admin = data.admin;
          authState.role = data.admin?.role || 'guest';
        } catch (error) {
          console.error(error);
          authState.isAuthorized = false;
          authState.role = 'guest';
          authState.admin = null;
        }

        updateAuthStatus();
        loadGroups();
        loadServices();
        loadBookings();
        loadAdmins();
        loadMasters();
        [gsExportBtn, gsImportBtn].forEach(btn => btn && (btn.disabled = !authState.isAuthorized));
      };

      // === Backup export/import ===
      gsExportBtn?.addEventListener('click', async () => {
        if (!authState.isAuthorized) { showBanner('Нет прав', 'error'); return; }
        try {
          const resp = await apiFetch('/api/backup/export');
          if (!resp.ok) { await handleError(resp); return; }
          const blob = await resp.blob();
          const disposition = resp.headers.get('Content-Disposition') || '';
          const match = disposition.match(/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/);
          const fname = decodeURIComponent(match?.[1] || match?.[2] || 'backup.zip');
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = fname; document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(url);
          showBanner('Экспортирован ZIP архив');
        } catch (e) {
          console.error(e); showBanner('Не удалось экспортировать архив', 'error');
        }
      });

      gsImportBtn?.addEventListener('click', async () => {
        if (!authState.isAuthorized) { showBanner('Нет прав', 'error'); return; }
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.zip,application/zip';
        input.onchange = async () => {
          const file = input.files?.[0];
          if (!file) return;
          const fd = new FormData();
          fd.append('file', file);
          const resp = await apiFetch('/api/backup/import', { method: 'POST', body: fd });
          if (!resp.ok) { await handleError(resp); return; }
          const result = await resp.json();
          // reload data
          loadGroups(); loadServices(); loadBookings(); loadAdmins(); loadMasters();
          showBanner(`Импортировано: ${result?.imported || 'OK'}`);
        };
        input.click();
      });

      // === Google Sheets export/import (Apps Script Web App) ===
      gsCsvExportBtn?.addEventListener('click', async () => {
        if (!authState.isAuthorized) { showBanner('Нет прав', 'error'); return; }
        try {
          const resp = await apiFetch('/api/gs/export', { method: 'POST' });
          const json = await resp.json();
          if (!resp.ok) { await handleError(resp); return; }
          showBanner('Экспортировано в Google Sheets');
          console.log('GS export:', json);
        } catch (e) { console.error(e); showBanner('GS экспорт не удался', 'error'); }
      });

      gsCsvImportBtn?.addEventListener('click', async () => {
        if (!authState.isAuthorized) { showBanner('Нет прав', 'error'); return; }
        try {
          const resp = await apiFetch('/api/gs/import', { method: 'POST' });
          const json = await resp.json();
          if (!resp.ok) { await handleError(resp); return; }
          // после импорта перезагружаем данные
          loadGroups(); loadServices(); loadBookings(); loadAdmins(); loadMasters();
          showBanner('Импортировано из Google Sheets');
          console.log('GS import:', json);
        } catch (e) { console.error(e); showBanner('GS импорт не удался', 'error'); }
      });

      const switchTab = (tab) => {
        state.activeTab = tab;
        tabsNav.forEach((button) => {
          button.classList.toggle('active', button.dataset.tab === tab);
        });
        tabPanels.forEach((panel) => {
          panel.classList.toggle('active', panel.dataset.tabPanel === tab);
        });
        if (tab === 'status') {
          refreshStatus();
          refreshLogs();
        }
      };

      tabsNav.forEach((button) => {
        button.addEventListener('click', () => {
          switchTab(button.dataset.tab);
        });
      });
      statusRefreshBtn?.addEventListener('click', refreshStatus);
      logsRefreshBtn?.addEventListener('click', refreshLogs);
      logsLimitSelect?.addEventListener('change', refreshLogs);
      seedDemoBtn?.addEventListener('click', seedDemoData);
      statusExportBtn?.addEventListener('click', exportZip);
      statusImportBtn?.addEventListener('click', importZip);

      const BOOKING_STATUS_LABELS = {
        pending: 'В ожидании',
        confirmed: 'Подтверждена',
        cancelled: 'Отменена'
      };

      const formatRub = (value) =>
        value == null
          ? '—'
          : new Intl.NumberFormat('ru-RU', {
              style: 'currency',
              currency: 'RUB',
              maximumFractionDigits: 0
            }).format(value);

      const renderServicesTable = () => {
        servicesTableBody.innerHTML = '';

        const rows = state.filterGroupId
          ? state.services.filter((service) => String(service.groupId) === String(state.filterGroupId))
          : state.services;

        if (!rows.length) {
          const emptyRow = document.createElement('tr');
          emptyRow.className = 'empty-row';
          const cell = document.createElement('td');
          cell.colSpan = 6;
          cell.textContent = 'Нет услуг для отображения';
          emptyRow.appendChild(cell);
          servicesTableBody.appendChild(emptyRow);
          return;
        }

        rows.forEach((service) => {
          const tr = document.createElement('tr');
          tr.dataset.id = service.id;

          const editable = authState.isAuthorized;

          const nameCell = document.createElement('td');
          nameCell.dataset.field = 'name';
          if (editable) nameCell.contentEditable = 'true';
          nameCell.textContent = service.name;

          const descCell = document.createElement('td');
          descCell.dataset.field = 'description';
          if (editable) descCell.contentEditable = 'true';
          descCell.textContent = service.description;

          const priceCell = document.createElement('td');
          priceCell.dataset.field = 'price';
          if (editable) priceCell.contentEditable = 'true';
          priceCell.textContent = service.price;

          const durationCell = document.createElement('td');
          durationCell.dataset.field = 'duration';
          if (editable) durationCell.contentEditable = 'true';
          durationCell.textContent = service.duration;

          const groupCell = document.createElement('td');
          const select = document.createElement('select');
          select.dataset.field = 'groupId';
          select.disabled = !editable;

          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = 'Без группы';
          select.appendChild(defaultOption);

          state.groups.forEach((group) => {
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = group.name;
            select.appendChild(option);
          });

          select.value = service.groupId ?? '';
          groupCell.appendChild(select);

          const actionsCell = document.createElement('td');
          actionsCell.className = 'table-actions';

          if (editable) {
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'danger-btn';
            deleteBtn.dataset.action = 'delete-service';
            deleteBtn.dataset.id = service.id;
            deleteBtn.textContent = 'Удалить';
            actionsCell.appendChild(deleteBtn);
          }

          tr.appendChild(nameCell);
          tr.appendChild(descCell);
          tr.appendChild(priceCell);
          tr.appendChild(durationCell);
          tr.appendChild(groupCell);
          tr.appendChild(actionsCell);

          servicesTableBody.appendChild(tr);
        });
      };

      const renderGroupsTable = () => {
        groupsTableBody.innerHTML = '';

        if (!state.groups.length) {
          const emptyRow = document.createElement('tr');
          emptyRow.className = 'empty-row';
          const cell = document.createElement('td');
          cell.colSpan = 2;
          cell.textContent = 'Групп пока нет';
          emptyRow.appendChild(cell);
          groupsTableBody.appendChild(emptyRow);
          return;
        }

        state.groups.forEach((group) => {
          const tr = document.createElement('tr');
          tr.dataset.id = group.id;

          const editable = authState.isAuthorized;

          const nameCell = document.createElement('td');
          nameCell.dataset.field = 'name';
          if (editable) nameCell.contentEditable = 'true';
          nameCell.textContent = group.name;

          const actionsCell = document.createElement('td');
          actionsCell.className = 'table-actions';

          if (editable) {
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'danger-btn';
            deleteBtn.dataset.action = 'delete-group';
            deleteBtn.dataset.id = group.id;
            deleteBtn.textContent = 'Удалить';
            actionsCell.appendChild(deleteBtn);
          }

          tr.appendChild(nameCell);
          tr.appendChild(actionsCell);
          groupsTableBody.appendChild(tr);
        });
      };

      const renderBookingsTable = () => {
        bookingsTableBody.innerHTML = '';

        if (!authState.telegramId) {
          const row = document.createElement('tr');
          row.className = 'empty-row';
          const cell = document.createElement('td');
          cell.colSpan = 6;
          cell.textContent = 'Чтобы просматривать записи, откройте панель из Telegram или введите свой Telegram ID.';
          row.appendChild(cell);
          bookingsTableBody.appendChild(row);
          updateDashboardCounters();
          return;
        }

        if (!state.bookings.length) {
          const row = document.createElement('tr');
          row.className = 'empty-row';
          const cell = document.createElement('td');
          cell.colSpan = 6;
          cell.textContent = 'Записей пока нет';
          row.appendChild(cell);
          bookingsTableBody.appendChild(row);
          updateDashboardCounters();
          return;
        }

        const sortedBookings = [...state.bookings].sort((a, b) => {
          const aDt = getBookingDateTime(a);
          const bDt = getBookingDateTime(b);
          const aTime = aDt ? aDt.getTime() : 0;
          const bTime = bDt ? bDt.getTime() : 0;
          return aTime - bTime;
        });

        sortedBookings.forEach((booking) => {
            const tr = document.createElement('tr');
            tr.dataset.id = booking.id;

            const startDate = getBookingDateTime(booking);
            const formattedDate = startDate
              ? startDate.toLocaleDateString('ru-RU', {
                  weekday: 'short',
                  day: '2-digit',
                  month: 'short'
                })
              : '—';
            const timeLabel = normalizeTimeString(booking.startTime) || (startDate
              ? toTimeLabel(startDate.getHours() * 60 + startDate.getMinutes())
              : '—');

            const timeCell = document.createElement('td');
            timeCell.innerHTML = `<strong>${timeLabel || '—'}</strong><br><span class="muted">${formattedDate}</span>`;

            const clientCell = document.createElement('td');
            clientCell.innerHTML = `
              <div><strong>${escapeHtml(booking.clientName)}</strong></div>
              <div class="muted">${escapeHtml(booking.clientPhone)}</div>
              ${booking.notes ? `<div class="muted">${escapeHtml(booking.notes)}</div>` : ''}
            `;

            const serviceCell = document.createElement('td');
            const durationValue = Number(booking.duration);
            const hasDuration = booking.duration !== null && booking.duration !== '' && Number.isFinite(durationValue);
            const durationLabel = hasDuration ? `${durationValue} мин` : '—';
            const priceValue = Number(booking.servicePrice);
            const hasPrice = booking.servicePrice !== null && booking.servicePrice !== '' && Number.isFinite(priceValue);
            const priceLabel = hasPrice ? formatRub(priceValue) : '—';
            const metaLabel = [durationLabel, priceLabel].filter((item) => item && item !== '—').join(' · ');
            serviceCell.innerHTML = `
              <div>${escapeHtml(booking.serviceName || '—')}</div>
              <div class="muted">${metaLabel || '—'}</div>
            `;

            
    const masterCell = document.createElement('td');

    const selected = booking.masterId ? state.masters.find(m => String(m.id) === String(booking.masterId)) : null;
    const title = selected ? selected.name : 'Не выбран';

    const eligibleMasters = state.masters.filter(m =>
      (m.serviceIds || []).map(String).includes(String(booking.serviceId))
    );

    if (authState.isAuthorized && eligibleMasters.length) {
      const select = document.createElement('select');
      const empty = document.createElement('option');
      empty.value = '';
      empty.textContent = '— не выбран —';
      select.appendChild(empty);

      eligibleMasters.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.name;
        opt.selected = String(booking.masterId) === String(m.id);
        select.appendChild(opt);
      });

      select.addEventListener('change', async () => {
        const masterId = select.value === '' ? null : select.value;
        const resp = await apiFetch(`/api/bookings/${booking.id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ masterId })
        });
        if (!resp.ok) { await handleError(resp); select.value = booking.masterId ?? ''; return; }
        await resp.json();
        showBanner('Мастер обновлён для записи');
        loadBookings();
      });

      masterCell.appendChild(select);
    } else {
      masterCell.textContent = title;
    }
    

            const statusCell = document.createElement('td');
            const badge = document.createElement('span');
            badge.className = `status-badge status-${booking.status}`;
            badge.textContent = BOOKING_STATUS_LABELS[booking.status] || booking.status;
            statusCell.appendChild(badge);

            const actionsCell = document.createElement('td');
            actionsCell.className = 'table-actions';

            if (authState.isAuthorized) {
              if (booking.status !== 'confirmed') {
                const confirmBtn = document.createElement('button');
                confirmBtn.type = 'button';
                confirmBtn.className = 'primary-btn';
                confirmBtn.dataset.action = 'confirm-booking';
                confirmBtn.dataset.id = booking.id;
                confirmBtn.textContent = 'Подтвердить';
                actionsCell.appendChild(confirmBtn);
              }

              if (booking.status !== 'cancelled') {
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.className = 'secondary-btn';
                cancelBtn.dataset.action = 'cancel-booking';
                cancelBtn.dataset.id = booking.id;
                cancelBtn.textContent = 'Отменить';
                actionsCell.appendChild(cancelBtn);
              }
            }

            tr.appendChild(timeCell);
            tr.appendChild(clientCell);
            tr.appendChild(serviceCell);
            tr.appendChild(masterCell);
            tr.appendChild(statusCell);
            tr.appendChild(actionsCell);

          bookingsTableBody.appendChild(tr);
        });

        updateDashboardCounters();
      };

      const renderAdminsTable = () => {
        adminsTableBody.innerHTML = '';

        if (!authState.isAuthorized) {
          const row = document.createElement('tr');
          row.className = 'empty-row';
          const cell = document.createElement('td');
          cell.colSpan = 5;
          cell.textContent = 'Доступ к списку администраторов ограничен.';
          row.appendChild(cell);
          adminsTableBody.appendChild(row);
          return;
        }

        if (!state.admins.length) {
          const row = document.createElement('tr');
          row.className = 'empty-row';
          const cell = document.createElement('td');
          cell.colSpan = 5;
          cell.textContent = 'Администраторы не найдены';
          row.appendChild(cell);
          adminsTableBody.appendChild(row);
          return;
        }

        state.admins
          .sort((a, b) => (a.role === 'owner' ? -1 : 1))
          .forEach((admin) => {
            const tr = document.createElement('tr');
            tr.dataset.id = admin.id;

            const idCell = document.createElement('td');
            idCell.textContent = admin.id;

            const usernameCell = document.createElement('td');
            usernameCell.textContent = `@${admin.username}`;

            const nameCell = document.createElement('td');
            nameCell.textContent = admin.displayName || '—';

            const roleCell = document.createElement('td');
            roleCell.textContent = admin.role === 'owner' ? 'Владелец' : 'Администратор';

            const actionsCell = document.createElement('td');
            actionsCell.className = 'table-actions';

            if (authState.role === 'owner' && admin.role !== 'owner') {
              const deleteBtn = document.createElement('button');
              deleteBtn.type = 'button';
              deleteBtn.className = 'danger-btn';
              deleteBtn.dataset.action = 'delete-admin';
              deleteBtn.dataset.id = admin.id;
              deleteBtn.textContent = 'Удалить';
              actionsCell.appendChild(deleteBtn);
            }

            tr.appendChild(idCell);
            tr.appendChild(usernameCell);
            tr.appendChild(nameCell);
            tr.appendChild(roleCell);
            tr.appendChild(actionsCell);

            adminsTableBody.appendChild(tr);
          });
      };

      const loadGroups = async () => {
        const response = await apiFetch('/api/groups');
        if (!response.ok) {
          await handleError(response);
          return;
        }
        state.groups = await response.json();
        renderGroupOptions();
        renderGroupFilter();
        renderGroupsTable();
        renderServicesTable();
        renderGroupOptionsForMasters();
      };

      const renderGroupOptions = () => {
        const options = ['<option value="">Без группы</option>'];
        state.groups.forEach((group) => {
          options.push(`<option value="${group.id}">${escapeHtml(group.name)}</option>`);
        });
        serviceFormGroupSelect.innerHTML = options.join('');
      };

      const renderGroupFilter = () => {
        const options = ['<option value="">Все группы</option>'];
        state.groups.forEach((group) => {
          options.push(`<option value="${group.id}">${escapeHtml(group.name)}</option>`);
        });
        groupFilter.innerHTML = options.join('');
        groupFilter.value = state.filterGroupId ?? '';
      };

      const loadServices = async () => {
        const response = await apiFetch('/api/services');
        if (!response.ok) {
          await handleError(response);
          return;
        }
        state.services = await response.json();
        renderServicesTable();
        renderMasterServiceOptions();
        renderServiceFilters();
      };

      const loadBookings = async () => {
        if (!authState.telegramId) {
          state.bookings = [];
          renderBookingsTable();
          return;
        }

        const params = new URLSearchParams();
        if (state.bookingStatusFilter !== 'all') {
          params.set('status', state.bookingStatusFilter);
        }

        const url = params.toString() ? `/api/bookings?${params.toString()}` : '/api/bookings';
        const response = await apiFetch(url);
        if (!response.ok) {
          await handleError(response);
          if (response.status === 401 || response.status === 403) {
            state.bookings = [];
            renderBookingsTable();
          }
          return;
        }

        state.bookings = await response.json();
        renderBookingsTable();
      };

      const loadAdmins = async () => {
        if (!authState.isAuthorized) {
          state.admins = [];
          renderAdminsTable();
          return;
        }

        const response = await apiFetch('/api/admins');
        if (!response.ok) {
          await handleError(response);
          return;
        }

        state.admins = await response.json();
        renderAdminsTable();
      };

      bookingStatusFilter.addEventListener('change', (event) => {
        state.bookingStatusFilter = event.target.value;
        loadBookings();
      });

      groupFilter.addEventListener('change', (event) => {
        const value = event.target.value;
        state.filterGroupId = value === '' ? null : value;
        renderServicesTable();
      });

      scheduleApplyBtn?.addEventListener('click', () => {
        showBanner('Интерактивное применение фильтров графика будет подключено после настройки API.', 'error');
      });

      scheduleTemplateBtn?.addEventListener('click', () => {
        showBanner('Редактор шаблонов расписаний появится в следующей версии.', 'error');
      });

      scheduleAddExceptionBtn?.addEventListener('click', () => {
        showBanner('Добавление исключений будет доступно после обновления сервера.', 'error');
      });

      scheduleCheckConflictsBtn?.addEventListener('click', () => {
        showBanner('Проверка конфликтов подключается к календарю — скоро появится.', 'error');
      });

      analyticsExportCsv?.addEventListener('click', () => {
        showBanner('Экспорт аналитики CSV станет доступен после подключения /api/reports.', 'error');
      });

      const notifyFiltersWip = () => {
        showBanner('Расширенные фильтры записей будут активны после интеграции API.', 'error');
      };

      [bookingMasterFilter, bookingServiceFilter, bookingSourceFilter]
        .forEach((element) => element?.addEventListener('change', notifyFiltersWip));
      [bookingDateFrom, bookingDateTo]
        .forEach((element) => element?.addEventListener('change', notifyFiltersWip));
      bookingSearchInput?.addEventListener('search', notifyFiltersWip);
      bookingSearchInput?.addEventListener('change', notifyFiltersWip);

      bookingCreateBtn?.addEventListener('click', () => {
        showBanner('Создание записи из панели появится после добавления /api/bookings POST.', 'error');
      });

      bookingMassConfirmBtn?.addEventListener('click', () => {
        showBanner('Массовые операции доступны после включения пакетных эндпоинтов.', 'error');
      });

      bookingMassCancelBtn?.addEventListener('click', () => {
        showBanner('Массовая отмена станет доступна после обновления API.', 'error');
      });

      bookingExportBtn?.addEventListener('click', () => {
        showBanner('Экспорт записей появится вместе с отчётами.', 'error');
      });

      sheetsConnectBtn?.addEventListener('click', () => {
        showBanner('Авторизация Google Sheets настраивается — подключение появится позже.', 'error');
      });

      sheetsSyncNowBtn?.addEventListener('click', () => {
        showBanner('Запрос синхронизации с Google Sheets будет активирован после внедрения API.', 'error');
      });

      telegramBotSettingsBtn?.addEventListener('click', () => {
        showBanner('Настройки Telegram-бота доступны в серверной конфигурации. Интерфейс добавим позже.', 'error');
      });

      telegramBroadcastBtn?.addEventListener('click', () => {
        showBanner('Рассылка в Telegram подключится после добавления пуш-методов в API.', 'error');
      });

      calendarConnectBtn?.addEventListener('click', () => {
        showBanner('Подключение Google Calendar находится в разработке.', 'error');
      });

      calendarSyncNowBtn?.addEventListener('click', () => {
        showBanner('Ручная синхронизация календаря станет доступна позже.', 'error');
      });

      webhookTestBtn?.addEventListener('click', () => {
        showBanner('Тестовый запрос webhook появится после реализации серверного обработчика.', 'error');
      });

      tokenGenerateBtn?.addEventListener('click', () => {
        const type = tokenTypeSelect?.value || 'manager';
        const masterId = tokenMasterSelect?.value;
        tokenOutput.textContent = `token://${type}/${masterId || 'common'} — функциональность появится после включения endpoints.`;
        showBanner('Генерация токенов будет реализована на бэкенде.', 'error');
      });

      tokenDeactivateBtn?.addEventListener('click', () => {
        showBanner('Деактивация токенов появится после добавления соответствующего API.', 'error');
      });

      auditRefreshBtn?.addEventListener('click', () => {
        auditLog.textContent = 'Ожидаю подключения /api/audit. Здесь появится журнал действий.';
        showBanner('Аудит будет доступен после подключения API.', 'error');
      });

      auditExportBtn?.addEventListener('click', () => {
        showBanner('Экспорт журнала аудита запланирован в серверной части.', 'error');
      });

      applyManualIdBtn.addEventListener('click', () => {
        const value = manualTelegramId.value.trim();
        if (!value) {
          showBanner('Введите Telegram ID', 'error');
          return;
        }
        setTelegramId(value);
      });

      clearManualIdBtn.addEventListener('click', () => {
        setTelegramId(null);
      });

      const ensureAuthorized = () => {
        if (!authState.isAuthorized) {
          showBanner('Нет прав для выполнения действия', 'error');
          return false;
        }
        return true;
      };

      const ensureOwner = () => {
        if (authState.role !== 'owner') {
          showBanner('Только владелец может выполнять действие', 'error');
          return false;
        }
        return true;
      };

      serviceForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!ensureAuthorized()) {
          return;
        }

        const formData = new FormData(serviceForm);
        const payload = {
          name: formData.get('name'),
          description: formData.get('description'),
          price: Number(formData.get('price')),
          duration: Number(formData.get('duration')),
          groupId: formData.get('groupId') ? formData.get('groupId') : null
        };

        const response = await apiFetch('/api/services', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          await handleError(response);
          return;
        }

        const created = await response.json();
        state.services.push(created);
        serviceForm.reset();
        renderServicesTable();
        showBanner('Услуга создана');
        await loadServices(); // обновляем селекты в «Мастера»
      });

      groupForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!ensureAuthorized()) {
          return;
        }

        const formData = new FormData(groupForm);
        const payload = { name: formData.get('name') };

        const response = await apiFetch('/api/groups', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          await handleError(response);
          return;
        }

        const created = await response.json();
        state.groups.push(created);
        groupForm.reset();
        renderGroupOptions();
        renderGroupFilter();
        renderGroupsTable();
        showBanner('Группа создана');
      });

      const updateServiceField = async (id, field, value) => {
        if (!ensureAuthorized()) {
          return null;
        }

        const response = await apiFetch(`/api/services/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [field]: value })
        });

        if (!response.ok) {
          await handleError(response);
          return null;
        }

        const updated = await response.json();
        const index = state.services.findIndex((service) => String(service.id) === String(id));
        if (index !== -1) {
          state.services[index] = updated;
        }
        return updated;
      };

      servicesTableBody.addEventListener('blur', async (event) => {
        const cell = event.target;
        if (!authState.isAuthorized || cell.dataset.field == null || cell.tagName !== 'TD') {
          return;
        }

        const row = cell.closest('tr');
        const id = row?.dataset.id || null;
        if (!id) {
          return;
        }

        const service = state.services.find((item) => String(item.id) === String(id));
        if (!service) {
          return;
        }

        const field = cell.dataset.field;
        let value = cell.textContent.trim();

        if (field === 'price' || field === 'duration') {
          const numberValue = Number(value);
          if (!Number.isFinite(numberValue) || numberValue <= 0) {
            cell.textContent = service[field];
            showBanner('Введите корректное число', 'error');
            return;
          }
          value = numberValue;
        }

        if (!value && (field === 'name' || field === 'description')) {
          cell.textContent = service[field];
          showBanner('Поле не может быть пустым', 'error');
          return;
        }

        const updated = await updateServiceField(id, field, value);
        if (!updated) {
          cell.textContent = service[field];
          return;
        }

        showBanner('Услуга обновлена');
        renderServicesTable();
      }, true);

      servicesTableBody.addEventListener('change', async (event) => {
        const select = event.target;
        if (!authState.isAuthorized || select.dataset.field !== 'groupId') {
          return;
        }

        const row = select.closest('tr');
        const id = row?.dataset.id || null;
        if (!id) {
          return;
        }

        const value = select.value === '' ? null : select.value;
        const updated = await updateServiceField(id, 'groupId', value);
        if (!updated) {
          const service = state.services.find((item) => String(item.id) === String(id));
          select.value = service?.groupId ?? '';
          return;
        }
        showBanner('Услуга обновлена');
      });

      servicesTableBody.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-action="delete-service"]');
        if (!button) {
          return;
        }

        if (!ensureAuthorized()) {
          return;
        }

        const id = button.dataset.id;
        if (!id || !confirm('Удалить услугу?')) {
          return;
        }

        const response = await apiFetch(`/api/services/${id}`, { method: 'DELETE' });
        if (!response.ok) {
          await handleError(response);
          return;
        }

        state.services = state.services.filter((service) => String(service.id) !== String(id));
        renderServicesTable();
        showBanner('Услуга удалена');
      });

      const updateGroupField = async (id, value) => {
        if (!ensureAuthorized()) {
          return null;
        }

        const response = await apiFetch(`/api/groups/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: value })
        });

        if (!response.ok) {
          await handleError(response);
          return null;
        }

        const updated = await response.json();
        const index = state.groups.findIndex((group) => String(group.id) === String(id));
        if (index !== -1) {
          state.groups[index] = updated;
        }
        return updated;
      };

      groupsTableBody.addEventListener('blur', async (event) => {
        const cell = event.target;
        if (!authState.isAuthorized || cell.dataset.field !== 'name') {
          return;
        }

        const row = cell.closest('tr');
        const id = row?.dataset.id || null;
        if (!id) {
          return;
        }

        const group = state.groups.find((item) => String(item.id) === String(id));
        if (!group) {
          return;
        }

        const value = cell.textContent.trim();
        if (!value) {
          cell.textContent = group.name;
          showBanner('Название группы не может быть пустым', 'error');
          return;
        }

        const updated = await updateGroupField(id, value);
        if (!updated) {
          cell.textContent = group.name;
          return;
        }

        renderGroupOptions();
        renderGroupFilter();
        renderServicesTable();
        showBanner('Группа обновлена');
      }, true);

      groupsTableBody.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-action="delete-group"]');
        if (!button) {
          return;
        }

        if (!ensureAuthorized()) {
          return;
        }

        const id = button.dataset.id;
        if (!id || !confirm('Удалить группу? Связанные услуги останутся без группы.')) {
          return;
        }

        const response = await apiFetch(`/api/groups/${id}`, { method: 'DELETE' });
        if (!response.ok) {
          await handleError(response);
          return;
        }

        state.groups = state.groups.filter((group) => String(group.id) !== String(id));
        state.services = state.services.map((service) =>
          String(service.groupId) === String(id) ? { ...service, groupId: null } : service
        );

        renderGroupOptions();
        renderGroupFilter();
        renderGroupsTable();
        renderServicesTable();
        showBanner('Группа удалена');
      });

      const updateBookingStatus = async (id, status) => {
        if (!ensureAuthorized()) {
          return;
        }

        const response = await apiFetch(`/api/bookings/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });

        if (!response.ok) {
          await handleError(response);
          return;
        }

        await response.json();
        showBanner(status === 'confirmed' ? 'Запись подтверждена' : 'Запись отменена');
        loadBookings();
      };

      bookingsTableBody.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button) {
          return;
        }

        const id = button.dataset.id;
        if (!id) {
          return;
        }

        if (button.dataset.action === 'confirm-booking') {
          updateBookingStatus(id, 'confirmed');
          return;
        }

        if (button.dataset.action === 'cancel-booking') {
          if (!confirm('Отменить запись? Клиент получит уведомление.')) {
            return;
          }
          updateBookingStatus(id, 'cancelled');
        }
      });

      adminForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!ensureOwner()) {
          return;
        }

        const formData = new FormData(adminForm);
        const payload = {
          id: Number(formData.get('id')),
          username: String(formData.get('username')).replace(/^@/, ''),
          displayName: formData.get('displayName') || undefined,
          role: formData.get('role')
        };

        const response = await apiFetch('/api/admins', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          await handleError(response);
          return;
        }

        await response.json();
        adminForm.reset();
        showBanner('Администратор добавлен');
        loadAdmins();
      });

      adminsTableBody.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-action="delete-admin"]');
        if (!button) {
          return;
        }

        if (!ensureOwner()) {
          return;
        }

        const id = Number(button.dataset.id);
        if (!id || !confirm('Удалить администратора?')) {
          return;
        }

        const response = await apiFetch(`/api/admins/${id}`, { method: 'DELETE' });
        if (!response.ok) {
          await handleError(response);
          return;
        }

        showBanner('Администратор удалён');
        loadAdmins();
      });

      // ===== MASTERS: загрузка =====
      const loadMasters = async () => {
        const response = await apiFetch('/api/masters');
        if (!response.ok) {
          await handleError(response);
          state.masters = [];
          renderMastersTable();
          renderMasterServiceOptions();
          return;
        }
        state.masters = (await response.json()).map((m) => ({
          ...m,
          serviceIds: Array.isArray(m.serviceIds) ? m.serviceIds.map((id) => String(id)) : []
        }));
        renderMastersTable();
        renderMasterServiceOptions();
      };

      // ===== MASTERS: опции услуг и фильтры =====
      const masterServicesPicker = document.getElementById('masterServicesPicker');
      const masterServicesChosen = document.getElementById('masterServicesChosen');
      const masterServicesAddBtn = document.getElementById('masterServicesAdd');
      const masterServicesRemoveBtn = document.getElementById('masterServicesRemove');

      const masterGroupPicker = document.getElementById('masterGroupPicker');
      const masterGroupAddBtn = document.getElementById('masterGroupAdd');

      const getChosenIds = () => Array.from(masterServicesChosen?.options || []).map((option) => option.value);

      const renderChosenServices = (ids = getChosenIds()) => {
        if (!masterServicesChosen) return;
        const byId = new Map(state.services.map((service) => [String(service.id), service]));
        masterServicesChosen.innerHTML = ids
          .map((id) => {
            const svc = byId.get(String(id));
            if (!svc) return '';
            return `<option value="${svc.id}">${escapeHtml(svc.name)} (${svc.duration} мин)</option>`;
          })
          .join('');
      };

      const updateMasterPickerOptions = () => {
        if (!masterServicesPicker || !masterServicesChosen) return;
        const chosen = new Set(getChosenIds().map(String));
        const options = state.services
          .filter((service) => !chosen.has(String(service.id)))
          .map((service) => `<option value="${service.id}">${escapeHtml(service.name)} (${service.duration} мин)</option>`);
        masterServicesPicker.innerHTML = options.join('');
        masterServicesPicker.disabled = options.length === 0;
      };

      const renderGroupOptionsForMasters = () => {
        if (!masterGroupPicker) return;
        masterGroupPicker.innerHTML = state.groups
          .map((group) => `<option value="${group.id}">${escapeHtml(group.name)}</option>`)
          .join('');
      };

      const renderMasterFilters = () => {
        const masterOptions = state.masters
          .map((master) => `<option value="${master.id}">${escapeHtml(master.name)}</option>`)
          .join('');

        if (scheduleMasterFilter) {
          const current = scheduleMasterFilter.value;
          scheduleMasterFilter.innerHTML = `<option value="">Все мастера</option>${masterOptions}`;
          if (current && state.masters.some((master) => String(master.id) === String(current))) {
            scheduleMasterFilter.value = current;
          }
        }

        if (analyticsMasterFilter) {
          const current = analyticsMasterFilter.value;
          analyticsMasterFilter.innerHTML = `<option value="">Все</option>${masterOptions}`;
          if (current && state.masters.some((master) => String(master.id) === String(current))) {
            analyticsMasterFilter.value = current;
          }
        }

        if (bookingMasterFilter) {
          const current = bookingMasterFilter.value;
          bookingMasterFilter.innerHTML = `<option value="">Все мастера</option>${masterOptions}`;
          if (current && state.masters.some((master) => String(master.id) === String(current))) {
            bookingMasterFilter.value = current;
          }
        }

        if (tokenMasterSelect) {
          const current = tokenMasterSelect.value;
          tokenMasterSelect.innerHTML = `<option value="">Не выбрано</option>${masterOptions}`;
          if (current && state.masters.some((master) => String(master.id) === String(current))) {
            tokenMasterSelect.value = current;
          }
        }
      };

      const renderServiceFilters = () => {
        if (!analyticsServiceFilter) return;
        const current = analyticsServiceFilter.value;
        const options = state.services
          .map((service) => `<option value="${service.id}">${escapeHtml(service.name)}</option>`)
          .join('');
        analyticsServiceFilter.innerHTML = `<option value="">Все</option>${options}`;
        if (current && state.services.some((service) => String(service.id) === String(current))) {
          analyticsServiceFilter.value = current;
        }
        if (bookingServiceFilter) {
          const currentBooking = bookingServiceFilter.value;
          bookingServiceFilter.innerHTML = `<option value="">Все услуги</option>${options}`;
          if (currentBooking && state.services.some((service) => String(service.id) === String(currentBooking))) {
            bookingServiceFilter.value = currentBooking;
          }
        }
      };

      const renderMasterServiceOptions = () => {
        if (!masterForm) return;
        updateMasterPickerOptions();
        renderChosenServices();
        renderGroupOptionsForMasters();
        renderMasterFilters();
      };

      masterServicesAddBtn?.addEventListener('click', () => {
        if (!masterServicesPicker) return;
        const value = masterServicesPicker.value;
        if (!value) {
          showBanner('Нет доступных услуг для добавления', 'error');
          return;
        }
        const ids = new Set(getChosenIds().map(String));
        ids.add(value);
        renderChosenServices(Array.from(ids));
        updateMasterPickerOptions();
      });

      masterServicesRemoveBtn?.addEventListener('click', () => {
        const toRemove = Array.from(masterServicesChosen?.selectedOptions || []).map((option) => option.value);
        if (!toRemove.length) {
          showBanner('Выберите услуги для удаления', 'error');
          return;
        }
        const ids = getChosenIds().filter((id) => !toRemove.includes(id));
        renderChosenServices(ids);
        updateMasterPickerOptions();
      });

      masterGroupAddBtn?.addEventListener('click', () => {
        const groupId = masterGroupPicker?.value;
        if (!groupId) return;
        const servicesInGroup = state.services
          .filter((service) => String(service.groupId) === String(groupId))
          .map((service) => service.id);
        const ids = new Set(getChosenIds().map(String));
        servicesInGroup.forEach((id) => ids.add(id));
        renderChosenServices(Array.from(ids));
        updateMasterPickerOptions();
      });

      const renderMastersTable = () => {
        mastersTableBody.innerHTML = '';

        if (!state.masters.length) {
          const row = document.createElement('tr');
          row.className = 'empty-row';
          const cell = document.createElement('td');
          cell.colSpan = 7;
          cell.textContent = 'Мастеров пока нет';
          row.appendChild(cell);
          mastersTableBody.appendChild(row);
          updateDashboardCounters();
          return;
        }

        state.masters.forEach((m) => {
          const tr = document.createElement('tr');
          tr.dataset.id = m.id;
          const editable = authState.isAuthorized;

          const photo = document.createElement('td');
          photo.innerHTML = m.photoUrl ? `<img src="${escapeHtml(m.photoUrl)}" alt="" style="width:44px;height:44px;border-radius:10px;object-fit:cover;border:1px solid rgba(148,163,184,.35)" />` : '—';

          const name = document.createElement('td');
          name.dataset.field = 'name';
          if (editable) name.contentEditable = 'true';
          name.textContent = m.name || '';

          const spec = document.createElement('td');
          spec.dataset.field = 'specialties';
          if (editable) spec.contentEditable = 'true';
          spec.textContent = (m.specialties || []).join(', ');

          const desc = document.createElement('td');
          desc.dataset.field = 'description';
          if (editable) desc.contentEditable = 'true';
          desc.textContent = m.description || '';

          const sched = document.createElement('td');
          const s = m.schedule || {};
          if (s.type === 'weekly') {
            const w = s.weekly || {};
            const daysLabel = (w.days || []).map(d => ['Вс','Пн','Вт','Ср','Чт','Пт','Сб'][d]).join(', ');
            const startTime = normalizeTimeString(w.start) || '—';
            const endTime = normalizeTimeString(w.end) || '—';
            sched.innerHTML = `Недели: <div class="muted">${daysLabel || '—'}</div><div class="muted">${startTime}–${endTime}</div>`;
          } else if (s.type === 'shift') {
            const sh = s.shift || {};
            const startTime = normalizeTimeString(sh.start) || '—';
            const endTime = normalizeTimeString(sh.end) || '—';
            sched.innerHTML = `Смены: <div class="muted">${sh.workDays||'?'} раб / ${sh.restDays||'?'} вых</div><div class="muted">${startTime}–${endTime}</div>`;
          } else {
            sched.textContent = '—';
          }

          const servicesCell = document.createElement('td');
          const names = (m.serviceIds || [])
            .map(id => state.services.find(svc => String(svc.id) === String(id))?.name)
            .filter(Boolean);
          servicesCell.innerHTML = names.length ? names.map(n => `<div>${escapeHtml(n)}</div>`).join('') : '—';

          const actions = document.createElement('td');
          actions.className = 'table-actions';
          if (editable) {
            const edit = document.createElement('button');
            edit.type = 'button';
            edit.className = 'icon-btn';
            edit.dataset.action = 'edit-master';
            edit.dataset.id = m.id;
            edit.title = 'Редактировать';
            edit.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>';
            actions.appendChild(edit);

            const del = document.createElement('button');
            del.type = 'button';
            del.className = 'icon-btn danger';
            del.dataset.action = 'delete-master';
            del.dataset.id = m.id;
            del.title = 'Удалить';
            del.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>';
            actions.appendChild(del);
          }

          tr.append(photo, name, spec, desc, sched, servicesCell, actions);
          mastersTableBody.appendChild(tr);
        });

        updateDashboardCounters();
      };

      // ===== MASTERS: обработчики формы и CRUD =====
      masterForm?.addEventListener('change', (e) => {
        if (e.target.name === 'scheduleType') {
          const type = e.target.value;
          masterForm.querySelector('[data-schedule="weekly"]').style.display = (type === 'weekly') ? 'grid' : 'none';
          masterForm.querySelector('[data-schedule="shift"]').style.display = (type === 'shift') ? 'grid' : 'none';
        }
      });

      masterForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!authState.isAuthorized) {
          showBanner('Нет прав для выполнения действия', 'error');
          return;
        }

        const fd = new FormData(masterForm);
        const scheduleType = fd.get('scheduleType');

        const specialties = String(fd.get('specialties') || '')
          .split(',')
          .map(s => s.trim())
          .filter(Boolean);

        const serviceIds = Array.from(document.getElementById('masterServicesChosen').options).map(o => o.value);

        const payload = {
          name: fd.get('name'),
          specialties,
          photoUrl: fd.get('photoUrl') || undefined,
          description: fd.get('description') || '',
          schedule: scheduleType === 'weekly' ? {
            type: 'weekly',
            weekly: {
              days: Array.from(masterForm.querySelectorAll('input[name="weeklyDays"]:checked')).map(i => Number(i.value)),
              start: fd.get('weeklyStart') || '10:00',
              end: fd.get('weeklyEnd') || '19:00'
            }
          } : {
            type: 'shift',
            shift: {
              workDays: Number(fd.get('shiftWork') || 2),
              restDays: Number(fd.get('shiftRest') || 2),
              anchorDate: fd.get('shiftAnchor') || new Date().toISOString().slice(0,10),
              start: fd.get('shiftStart') || '10:00',
              end: fd.get('shiftEnd') || '19:00'
            }
          },
          serviceIds
        };

        const response = await apiFetch('/api/masters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          await handleError(response);
          return;
        }

        const created = await response.json();
        state.masters.push(created);
        masterForm.reset();
        renderChosenServices([]);
        updateMasterPickerOptions();
        renderMasterServiceOptions();
        renderMastersTable();
        showBanner('Мастер добавлен');
      });

      const updateMasterField = async (id, patch) => {
        const response = await apiFetch(`/api/masters/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(patch)
        });
        if (!response.ok) {
          await handleError(response);
          return null;
        }
        const updated = await response.json();
        const idx = state.masters.findIndex(m => String(m.id) === String(id));
        if (idx !== -1) state.masters[idx] = updated;
        return updated;
      };

      mastersTableBody?.addEventListener('blur', async (e) => {
        const cell = e.target;
        if (!authState.isAuthorized || cell.tagName !== 'TD' || !cell.dataset.field) return;
        const row = cell.closest('tr'); const id = row?.dataset.id || null;
        if (!id) return;
        const master = state.masters.find(m => String(m.id) === String(id)); if (!master) return;

        const field = cell.dataset.field;
        let value = cell.textContent.trim();

        if (!value && (field === 'name')) {
          cell.textContent = master[field] || '';
          showBanner('Имя не может быть пустым', 'error'); return;
        }

        if (field === 'specialties') {
          value = value ? value.split(',').map(s => s.trim()).filter(Boolean) : [];
          const ok = await updateMasterField(id, { specialties: value });
          if (!ok) cell.textContent = (master.specialties||[]).join(', ');
          else showBanner('Мастер обновлён');
          return;
        }

        const ok = await updateMasterField(id, { [field]: value });
        if (!ok) cell.textContent = master[field] || '';
        else showBanner('Мастер обновлён');
      }, true);

      // (removed obsolete in-row serviceIds select change handler)

      mastersTableBody?.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        if (btn.dataset.action === 'edit-master') {
          if (!authState.isAuthorized) { showBanner('Нет прав', 'error'); return; }
          const row = btn.closest('tr');
          row.querySelectorAll('td[data-field="name"], td[data-field="specialties"], td[data-field="description"]').forEach(td => {
            td.contentEditable = 'true';
            td.classList.add('editing');
          });
          btn.style.display = 'none';
          const saveBtn = row.querySelector('button[data-action="save-master"]');
          if (saveBtn) saveBtn.style.display = '';
          return;
        }

        if (btn.dataset.action === 'save-master') {
          if (!authState.isAuthorized) { showBanner('Нет прав', 'error'); return; }
          const row = btn.closest('tr');
          const id = row?.dataset.id || null;
          const master = state.masters.find(m => String(m.id) === String(id));
          if (!master) return;

          const name = row.querySelector('td[data-field="name"]').textContent.trim();
          const specialtiesStr = row.querySelector('td[data-field="specialties"]').textContent.trim();
          const description = row.querySelector('td[data-field="description"]').textContent.trim();
          if (!name) { showBanner('Имя не может быть пустым', 'error'); return; }

          const patch = {
            name,
            specialties: specialtiesStr ? specialtiesStr.split(',').map(s=>s.trim()).filter(Boolean) : [] ,
            description
          };
          const ok = await updateMasterField(id, patch);
          if (ok) {
            showBanner('Мастер сохранён');
            // выключаем режим редактирования
            row.querySelectorAll('td[data-field]').forEach(td => { td.contentEditable = 'false'; td.classList.remove('editing'); });
            const editBtn = row.querySelector('button[data-action="edit-master"]');
            if (editBtn) editBtn.style.display = '';
            btn.style.display = 'none';
          }
          return;
        }

        if (btn.dataset.action === 'delete-master') {
          if (!authState.isAuthorized) { showBanner('Нет прав', 'error'); return; }
          const id = btn.dataset.id;
          if (!id || !confirm('Удалить мастера?')) return;
          const response = await apiFetch(`/api/masters/${id}`, { method: 'DELETE' });
          if (!response.ok) { await handleError(response); return; }
          state.masters = state.masters.filter(m => String(m.id) !== String(id));
          renderMastersTable();
          showBanner('Мастер удалён');
          return;
        }
      });

            // ===== INITIALIZE APP =====
      const initialId = detectTelegramId();
      if (initialId) {
        authState.telegramId = initialId;
      }
      updateAuthStatus();
      refreshAccess();
      switchTab(state.activeTab);
    });

</script>

</body>
