<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Beauty Appointments — Панель администратора</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      color-scheme: light;
      font-family: 'SF Pro Display', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      margin: 0;
      padding: 32px;
      background: #f4f6fb;
      color: #0f172a;
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      gap: 28px;
    }

    h1 {
      margin: 0;
      font-size: clamp(28px, 4vw, 36px);
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(14px);
      border-radius: 20px;
      padding: 24px 26px;
      box-shadow: 0 35px 60px -40px rgba(15, 23, 42, 0.35);
      border: 1px solid rgba(209, 213, 219, 0.45);
    }

    .auth-card {
      display: grid;
      gap: 14px;
    }

    .auth-card p {
      margin: 0;
      font-size: 15px;
      color: #4b5563;
    }

    .auth-card small {
      color: #6b7280;
    }

    .auth-dev {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
      margin-top: 8px;
    }

    .auth-dev label {
      display: grid;
      gap: 6px;
      font-size: 13px;
      color: #475569;
    }

    nav.tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    nav.tabs button {
      border: none;
      border-radius: 12px;
      padding: 10px 18px;
      font-size: 15px;
      font-weight: 600;
      background: #e7ecf7;
      color: #0f172a;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }

    nav.tabs button.active {
      background: linear-gradient(130deg, #5ec5ff, #007aff);
      color: #fff;
      box-shadow: 0 18px 32px -24px rgba(0, 122, 255, 0.45);
    }

    nav.tabs button:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 28px -22px rgba(15, 23, 42, 0.35);
    }

    .tab-panel {
      display: none;
      gap: 24px;
    }

    .tab-panel.active {
      display: grid;
    }

    .form-grid {
      display: grid;
      gap: 16px;
    }

    .form-grid label {
      display: grid;
      gap: 6px;
      font-size: 14px;
      color: #4b5563;
    }

    input,
    textarea,
    select {
      border: 1px solid rgba(148, 163, 184, 0.45);
      border-radius: 12px;
      padding: 11px 14px;
      font-size: 14px;
      font-family: inherit;
      background: rgba(255, 255, 255, 0.96);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: rgba(0, 122, 255, 0.9);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.18);
      background: #fff;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    button.primary-btn,
    button.secondary-btn,
    button.danger-btn {
      cursor: pointer;
      border: none;
      border-radius: 12px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }

    button.primary-btn:hover,
    button.secondary-btn:hover,
    button.danger-btn:hover {
      transform: translateY(-1px);
    }

    .primary-btn {
      background: linear-gradient(135deg, #5ec5ff, #007aff);
      color: #fff;
      box-shadow: 0 18px 28px -20px rgba(0, 122, 255, 0.45);
    }

    .secondary-btn {
      background: #f3f6fc;
      color: #0f172a;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .danger-btn {
      background: linear-gradient(135deg, #ff9eb5, #ff6b81);
      color: #fff;
      box-shadow: 0 16px 26px -22px rgba(255, 107, 129, 0.45);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 14px;
    }

    th,
    td {
      border-bottom: 1px solid rgba(226, 232, 240, 0.9);
      padding: 12px 10px;
      text-align: left;
      vertical-align: top;
    }

    thead th {
      background: #f8f9fc;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 12px;
      font-weight: 600;
      color: #7b8395;
    }

    tbody tr:hover {
      background: rgba(94, 197, 255, 0.06);
    }

    td[contenteditable="true"] {
      border-radius: 6px;
      min-width: 120px;
      outline: none;
    }

    td[contenteditable="true"]:focus {
      background: rgba(94, 197, 255, 0.1);
      box-shadow: inset 0 0 0 2px rgba(0, 122, 255, 0.35);
    }

    .table-actions {
      width: 140px;
      display: flex;
      gap: 8px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.02em;
      background: #e2e8f0;
      color: #0f172a;
    }

    .status-badge::before {
      content: '';
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .status-pending {
      background: rgba(59, 130, 246, 0.16);
      color: #1d4ed8;
    }

    .status-confirmed {
      background: rgba(34, 197, 94, 0.18);
      color: #047857;
    }

    .status-cancelled {
      background: rgba(248, 113, 113, 0.18);
      color: #b91c1c;
    }

    .empty-row td {
      text-align: center;
      color: #94a3b8;
      font-style: italic;
    }

    .muted {
      color: #64748b;
      font-size: 13px;
    }

    .warning-card {
      margin-top: 16px;
      padding: 14px 16px;
      border-radius: 12px;
      background: rgba(255, 237, 213, 0.75);
      border: 1px solid rgba(251, 191, 36, 0.45);
      color: #92400e;
      font-size: 14px;
    }

    .banner {
      position: fixed;
      bottom: 22px;
      right: 22px;
      padding: 14px 20px;
      border-radius: 12px;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #34c759, #28b24a);
      box-shadow: 0 22px 38px -26px rgba(40, 178, 74, 0.6);
      opacity: 0;
      pointer-events: none;
      transform: translateY(18px);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .banner.show {
      opacity: 1;
      transform: translateY(0);
    }

    .banner.error {
      background: linear-gradient(135deg, #ff5f5f, #f43f5e);
      box-shadow: 0 22px 38px -26px rgba(244, 63, 94, 0.55);
    }

    @media (max-width: 960px) {
      body {
        padding: 22px;
      }

      section {
        padding: 20px;
      }

      .table-actions {
        flex-direction: column;
        width: auto;
      }
    }
  </style>
</head>
<body>
  <main>
    <h1>Панель администратора</h1>

    <section class="auth-card" id="authCard">
      <h2>Доступ</h2>
      <p id="authStatus">Проверяю доступ…</p>
      <small>Панель доступна только администраторам, чьи Telegram ID добавлены в список. В мини-приложении данные приходят автоматически.</small>
      <div class="auth-dev">
        <label>
          Telegram ID для локального доступа
          <input type="number" id="manualTelegramId" placeholder="Например: 486778995" />
        </label>
        <button type="button" class="secondary-btn" id="applyManualIdBtn">Сохранить</button>
        <button type="button" class="secondary-btn" id="clearManualIdBtn">Сбросить</button>
      </div>
    </section>

    <nav class="tabs">
      <button data-tab="bookings" class="active">Записи</button>
      <button data-tab="services">Услуги</button>
  <button data-tab="masters">Мастера</button>
      <button data-tab="groups">Группы</button>
      <button data-tab="admins">Администраторы</button>
    </nav>

    <section class="tab-panel active" data-tab-panel="bookings">
      <div class="section-header">
        <h2>Записи клиентов</h2>
        <label>
          Статус
          <select id="bookingStatusFilter">
            <option value="all">Все</option>
            <option value="pending" selected>В ожидании</option>
            <option value="confirmed">Подтверждённые</option>
            <option value="cancelled">Отменённые</option>
          </select>
        </label>
      </div>
      <div class="warning-card" id="bookingsWarning" hidden>
        Добавьте свой Telegram ID в список администраторов, чтобы подтверждать и отменять записи.
      </div>
      <table id="bookingsTable">
        <thead>
          <tr>
            <th>Время</th>
            <th>Клиент</th>
            <th>Услуга</th>
            <th>Мастер</th>
            <th>Статус</th>
            <th class="table-actions">Действия</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="tab-panel" data-tab-panel="masters">
  <div class="form-grid">
    <div>
      <h2>Добавить мастера</h2>
      <form id="masterForm" class="form-grid">
        <label>
          Имя
          <input type="text" name="name" required placeholder="Например: Анна Петрова" />
        </label>
        <label>
          Специальности (через запятую)
          <input type="text" name="specialties" placeholder="бровист, визажист" />
        </label>
        <label>
          Фото (URL)
          <input type="url" name="photoUrl" placeholder="https://…/photo.jpg" />
        </label>
        <label>
          Описание
          <textarea name="description" placeholder="Кратко о мастере"></textarea>
        </label>

        <fieldset style="border:none;padding:0;margin:0;display:grid;gap:12px">
          <legend class="muted" style="margin-bottom:4px">Расписание</legend>
          <label>
            Тип расписания
            <select name="scheduleType">
              <option value="weekly" selected>По дням недели</option>
              <option value="shift">Смены (2/2 и т.п.)</option>
            </select>
          </label>

          <div data-schedule="weekly" class="form-grid">
            <label>Дни недели
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <label><input type="checkbox" name="weeklyDays" value="1" /> Пн</label>
                <label><input type="checkbox" name="weeklyDays" value="2" /> Вт</label>
                <label><input type="checkbox" name="weeklyDays" value="3" /> Ср</label>
                <label><input type="checkbox" name="weeklyDays" value="4" /> Чт</label>
                <label><input type="checkbox" name="weeklyDays" value="5" /> Пт</label>
                <label><input type="checkbox" name="weeklyDays" value="6" /> Сб</label>
                <label><input type="checkbox" name="weeklyDays" value="0" /> Вс</label>
              </div>
            </label>
            <label>Начало <input type="time" name="weeklyStart" value="10:00" /></label>
            <label>Конец <input type="time" name="weeklyEnd" value="19:00" /></label>
          </div>

          <div data-schedule="shift" class="form-grid" style="display:none">
            <label>Смена: рабочих дней
              <input type="number" name="shiftWork" min="1" value="2" />
            </label>
            <label>Смена: выходных дней
              <input type="number" name="shiftRest" min="1" value="2" />
            </label>
            <label>Опорная дата (начало рабочей смены)
              <input type="date" name="shiftAnchor" />
            </label>
            <label>Начало <input type="time" name="shiftStart" value="10:00" /></label>
            <label>Конец <input type="time" name="shiftEnd" value="19:00" /></label>
          </div>
        </fieldset>

        <label>
          Услуги мастера
          <select name="serviceIds" multiple size="6"></select>
        </label>

        <button type="submit" class="primary-btn">Добавить мастера</button>
      </form>
    </div>
  </div>

  <h2>Список мастеров</h2>
  <table id="mastersTable">
    <thead>
      <tr>
        <th>Фото</th>
        <th>Имя</th>
        <th>Спец-ть</th>
        <th>Описание</th>
        <th>Расписание</th>
        <th>Услуги</th>
        <th class="table-actions">Действия</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>
<section class="tab-panel" data-tab-panel="services">
      <div class="form-grid">
        <div>
          <h2>Добавить услугу</h2>
          <form id="serviceForm" class="form-grid">
            <label>
              Название
              <input type="text" name="name" placeholder="Например: SPA-массаж" required />
            </label>
            <label>
              Описание
              <textarea name="description" placeholder="Кратко опишите услугу" required></textarea>
            </label>
            <label>
              Цена (₽)
              <input type="number" name="price" min="0" step="1" required />
            </label>
            <label>
              Длительность (мин)
              <input type="number" name="duration" min="30" step="5" required />
            </label>
            <label>
              Группа
              <select name="groupId">
                <option value="">Без группы</option>
              </select>
            </label>
            <button type="submit" class="primary-btn">Добавить услугу</button>
          </form>
        </div>
      </div>
      <div class="section-header" style="margin-top:12px;">
        <h2>Список услуг</h2>
        <label>
          Фильтр по группе
          <select id="groupFilter">
            <option value="">Все группы</option>
          </select>
        </label>
      </div>
      <table id="servicesTable">
        <thead>
          <tr>
            <th>Название</th>
            <th>Описание</th>
            <th>Цена, ₽</th>
            <th>Длительность</th>
            <th>Группа</th>
            <th class="table-actions">Действия</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="tab-panel" data-tab-panel="groups">
      <div class="form-grid">
        <div>
          <h2>Добавить группу</h2>
          <form id="groupForm" class="form-grid">
            <label>
              Название группы
              <input type="text" name="name" placeholder="Например: Косметология" required />
            </label>
            <button type="submit" class="secondary-btn">Создать группу</button>
          </form>
        </div>
      </div>
      <h2>Все группы</h2>
      <table id="groupsTable">
        <thead>
          <tr>
            <th>Название</th>
            <th class="table-actions">Действия</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="tab-panel" data-tab-panel="admins">
      <div class="form-grid">
        <div>
          <h2>Добавить администратора</h2>
          <form id="adminForm" class="form-grid">
            <label>
              Telegram ID
              <input type="number" name="id" min="1" step="1" placeholder="Например: 123456789" required />
            </label>
            <label>
              Username (без @)
              <input type="text" name="username" placeholder="Например: beauty_manager" required />
            </label>
            <label>
              Отображаемое имя (необязательно)
              <input type="text" name="displayName" placeholder="Имя для списка" />
            </label>
            <label>
              Роль
              <select name="role">
                <option value="admin" selected>Администратор</option>
                <option value="owner">Владелец</option>
              </select>
            </label>
            <button type="submit" class="primary-btn">Добавить администратора</button>
          </form>
        </div>
      </div>
      <h2>Список администраторов</h2>
      <div class="warning-card" id="adminsWarning" hidden>
        Только владелец может добавлять и удалять администраторов.
      </div>
      <table id="adminsTable">
        <thead>
          <tr>
            <th>Telegram ID</th>
            <th>Username</th>
            <th>Имя</th>
            <th>Роль</th>
            <th class="table-actions">Действия</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <div class="banner" id="banner" hidden></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const state = {
        services: [],
        groups: [],
        bookings: [],
        admins: [],
  masters: [],
        filterGroupId: null,
        bookingStatusFilter: 'pending',
        activeTab: 'bookings'
      };

      const servicesTableBody = document.querySelector('#servicesTable tbody');
      const groupsTableBody = document.querySelector('#groupsTable tbody');
      const bookingsTableBody = document.querySelector('#bookingsTable tbody');
      const adminsTableBody = document.querySelector('#adminsTable tbody');

      const mastersTableBody = document.querySelector('#mastersTable tbody');
const masterForm = document.getElementById('masterForm');
const bookingStatusFilter = document.getElementById('bookingStatusFilter');
      const groupFilter = document.getElementById('groupFilter');
      const adminForm = document.getElementById('adminForm');
      const serviceForm = document.getElementById('serviceForm');
      const groupForm = document.getElementById('groupForm');
      const serviceFormGroupSelect = serviceForm.querySelector('select[name="groupId"]');
      const banner = document.getElementById('banner');

      const authStatus = document.getElementById('authStatus');
      const manualTelegramId = document.getElementById('manualTelegramId');
      const applyManualIdBtn = document.getElementById('applyManualIdBtn');
      const clearManualIdBtn = document.getElementById('clearManualIdBtn');
      const bookingsWarning = document.getElementById('bookingsWarning');
      const adminsWarning = document.getElementById('adminsWarning');

      const tabsNav = document.querySelectorAll('nav.tabs button');
      const tabPanels = document.querySelectorAll('.tab-panel');

      const AUTH_STORAGE_KEY = 'beauty_admin_telegram_id_v1';

      const authState = {
        telegramId: null,
        role: 'guest',
        admin: null,
        isAuthorized: false
      };

      const escapeHtml = (value = '') =>
        String(value).replace(/[&<>"']/g, (char) => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        })[char] || char);

      const showBanner = (message, type = 'success') => {
        banner.textContent = message;
        banner.classList.toggle('error', type === 'error');
        banner.classList.add('show');
        banner.hidden = false;
        setTimeout(() => {
          banner.classList.remove('show');
          setTimeout(() => {
            banner.hidden = true;
          }, 180);
        }, 2300);
      };

      const withAuthHeaders = (headers = {}) => {
        const result = { ...headers };
        if (authState.telegramId) {
          result['X-Telegram-Id'] = authState.telegramId;
        }
        return result;
      };

      const apiFetch = async (input, options = {}) => {
        const init = { ...options };
        init.headers = withAuthHeaders(init.headers || {});
        const response = await fetch(input, init);
        if (response.status === 401) {
          showBanner('Укажите Telegram ID администратора', 'error');
          updateAuthStatus();
        } else if (response.status === 403) {
          showBanner('Недостаточно прав для действия', 'error');
          updateAuthStatus();
        }
        return response;
      };

      const handleError = async (response) => {
        if (response.status === 401 || response.status === 403) {
          return;
        }
        let errorMessage = 'Что-то пошло не так';
        try {
          const payload = await response.json();
          if (payload?.error) {
            errorMessage = payload.error;
          }
        } catch (_) {}
        showBanner(errorMessage, 'error');
      };

      const detectTelegramId = () => {
        const telegram = window.Telegram?.WebApp;
        if (telegram?.initDataUnsafe?.user?.id) {
          return Number(telegram.initDataUnsafe.user.id);
        }
        const urlParams = new URLSearchParams(window.location.search);
        const paramId = Number(urlParams.get('tg_id'));
        if (Number.isFinite(paramId) && paramId > 0) {
          return paramId;
        }
        const storedId = Number(localStorage.getItem(AUTH_STORAGE_KEY));
        if (Number.isFinite(storedId) && storedId > 0) {
          return storedId;
        }
        return null;
      };

      const setTelegramId = (value) => {
        if (value == null) {
          authState.telegramId = null;
          localStorage.removeItem(AUTH_STORAGE_KEY);
        } else {
          const numeric = Number(value);
          if (!Number.isFinite(numeric) || numeric <= 0) {
            showBanner('Введите корректный Telegram ID', 'error');
            return;
          }
          authState.telegramId = numeric;
          localStorage.setItem(AUTH_STORAGE_KEY, String(numeric));
        }
        updateAuthStatus();
        refreshAccess();
      };

      const updateAuthStatus = () => {
        if (!authState.telegramId) {
          authStatus.textContent = 'Telegram ID не определён. Введите ID вручную или откройте панель из Telegram.';
          manualTelegramId.value = '';
          bookingsWarning.hidden = true;
          adminsWarning.hidden = true;
          return;
        }

        manualTelegramId.value = authState.telegramId;
        if (authState.isAuthorized) {
          const roleLabel = authState.role === 'owner' ? 'Владелец' : 'Администратор';
          authStatus.textContent = `Доступ разрешён (${roleLabel}). Telegram ID: ${authState.telegramId}`;
        } else {
          authStatus.textContent = `Telegram ID ${authState.telegramId} не найден в списке администраторов.`;
        }

        bookingsWarning.hidden = authState.isAuthorized;
        adminsWarning.hidden = authState.role === 'owner' || !authState.isAuthorized;
        adminForm.querySelectorAll('input, select, button').forEach((el) => {
          el.disabled = !(authState.role === 'owner');
        });
      };

      const refreshAccess = async () => {
        if (!authState.telegramId) {
          authState.isAuthorized = false;
          authState.role = 'guest';
          authState.admin = null;
          updateAuthStatus();
          renderServicesTable();
          renderGroupsTable();
          renderBookingsTable();
          renderAdminsTable();
          return;
        }

        try {
          const response = await apiFetch('/api/admins/me');
          if (!response.ok) {
            authState.isAuthorized = false;
            authState.role = 'guest';
            authState.admin = null;
            updateAuthStatus();
            return;
          }
          const data = await response.json();
          authState.isAuthorized = Boolean(data.authenticated);
          authState.admin = data.admin;
          authState.role = data.admin?.role || 'guest';
        } catch (error) {
          console.error(error);
          authState.isAuthorized = false;
          authState.role = 'guest';
          authState.admin = null;
        }

        updateAuthStatus();
        loadGroups();
        loadServices();
        loadBookings();
        loadAdmins();
  loadMasters();
      };

      const switchTab = (tab) => {
        state.activeTab = tab;
        tabsNav.forEach((button) => {
          button.classList.toggle('active', button.dataset.tab === tab);
        });
        tabPanels.forEach((panel) => {
          panel.classList.toggle('active', panel.dataset.tabPanel === tab);
        });
      };

      tabsNav.forEach((button) => {
        button.addEventListener('click', () => {
          switchTab(button.dataset.tab);
        });
      });

      const BOOKING_STATUS_LABELS = {
        pending: 'В ожидании',
        confirmed: 'Подтверждена',
        cancelled: 'Отменена'
      };

      const formatRub = (value) =>
        value == null
          ? '—'
          : new Intl.NumberFormat('ru-RU', {
              style: 'currency',
              currency: 'RUB',
              maximumFractionDigits: 0
            }).format(value);

      const renderServicesTable = () => {
        servicesTableBody.innerHTML = '';

        const rows = state.filterGroupId
          ? state.services.filter((service) => service.groupId === state.filterGroupId)
          : state.services;

        if (!rows.length) {
          const emptyRow = document.createElement('tr');
          emptyRow.className = 'empty-row';
          const cell = document.createElement('td');
          cell.colSpan = 6;
          cell.textContent = 'Нет услуг для отображения';
          emptyRow.appendChild(cell);
          servicesTableBody.appendChild(emptyRow);
          return;
        }

        rows.forEach((service) => {
          const tr = document.createElement('tr');
          tr.dataset.id = service.id;

          const editable = authState.isAuthorized;

          const nameCell = document.createElement('td');
          nameCell.dataset.field = 'name';
          if (editable) nameCell.contentEditable = 'true';
          nameCell.textContent = service.name;

          const descCell = document.createElement('td');
          descCell.dataset.field = 'description';
          if (editable) descCell.contentEditable = 'true';
          descCell.textContent = service.description;

          const priceCell = document.createElement('td');
          priceCell.dataset.field = 'price';
          if (editable) priceCell.contentEditable = 'true';
          priceCell.textContent = service.price;

          const durationCell = document.createElement('td');
          durationCell.dataset.field = 'duration';
          if (editable) durationCell.contentEditable = 'true';
          durationCell.textContent = service.duration;

          const groupCell = document.createElement('td');
          const select = document.createElement('select');
          select.dataset.field = 'groupId';
          select.disabled = !editable;

          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = 'Без группы';
          select.appendChild(defaultOption);

          state.groups.forEach((group) => {
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = group.name;
            select.appendChild(option);
          });

          select.value = service.groupId ?? '';
          groupCell.appendChild(select);

          const actionsCell = document.createElement('td');
          actionsCell.className = 'table-actions';

          if (editable) {
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'danger-btn';
            deleteBtn.dataset.action = 'delete-service';
            deleteBtn.dataset.id = service.id;
            deleteBtn.textContent = 'Удалить';
            actionsCell.appendChild(deleteBtn);
          }

          tr.appendChild(nameCell);
          tr.appendChild(descCell);
          tr.appendChild(priceCell);
          tr.appendChild(durationCell);
          tr.appendChild(groupCell);
          tr.appendChild(actionsCell);

          servicesTableBody.appendChild(tr);
        });
      };

      const renderGroupsTable = () => {
        groupsTableBody.innerHTML = '';

        if (!state.groups.length) {
          const emptyRow = document.createElement('tr');
          emptyRow.className = 'empty-row';
          const cell = document.createElement('td');
          cell.colSpan = 2;
          cell.textContent = 'Групп пока нет';
          emptyRow.appendChild(cell);
          groupsTableBody.appendChild(emptyRow);
          return;
        }

        state.groups.forEach((group) => {
          const tr = document.createElement('tr');
          tr.dataset.id = group.id;

          const editable = authState.isAuthorized;

          const nameCell = document.createElement('td');
          nameCell.dataset.field = 'name';
          if (editable) nameCell.contentEditable = 'true';
          nameCell.textContent = group.name;

          const actionsCell = document.createElement('td');
          actionsCell.className = 'table-actions';

          if (editable) {
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'danger-btn';
            deleteBtn.dataset.action = 'delete-group';
            deleteBtn.dataset.id = group.id;
            deleteBtn.textContent = 'Удалить';
            actionsCell.appendChild(deleteBtn);
          }

          tr.appendChild(nameCell);
          tr.appendChild(actionsCell);
          groupsTableBody.appendChild(tr);
        });
      };

      const renderBookingsTable = () => {
        bookingsTableBody.innerHTML = '';

        if (!authState.telegramId) {
          const row = document.createElement('tr');
          row.className = 'empty-row';
          const cell = document.createElement('td');
          cell.colSpan = 6;
          cell.textContent = 'Чтобы просматривать записи, откройте панель из Telegram или введите свой Telegram ID.';
          row.appendChild(cell);
          bookingsTableBody.appendChild(row);
          return;
        }

        if (!state.bookings.length) {
          const row = document.createElement('tr');
          row.className = 'empty-row';
          const cell = document.createElement('td');
          cell.colSpan = 6;
          cell.textContent = 'Записей пока нет';
          row.appendChild(cell);
          bookingsTableBody.appendChild(row);
          return;
        }

        state.bookings
          .sort((a, b) => new Date(`${a.date}T${a.startTime}`) - new Date(`${b.date}T${b.startTime}`))
          .forEach((booking) => {
            const tr = document.createElement('tr');
            tr.dataset.id = booking.id;

            const startDate = new Date(`${booking.date}T${booking.startTime}:00`);
            const formattedDate = startDate.toLocaleDateString('ru-RU', {
              weekday: 'short',
              day: '2-digit',
              month: 'short'
            });

            const timeCell = document.createElement('td');
            timeCell.innerHTML = `<strong>${booking.startTime}</strong><br><span class="muted">${formattedDate}</span>`;

            const clientCell = document.createElement('td');
            clientCell.innerHTML = `
              <div><strong>${escapeHtml(booking.clientName)}</strong></div>
              <div class="muted">${escapeHtml(booking.clientPhone)}</div>
              ${booking.notes ? `<div class="muted">${escapeHtml(booking.notes)}</div>` : ''}
            `;

            const serviceCell = document.createElement('td');
            serviceCell.innerHTML = `
              <div>${escapeHtml(booking.serviceName || '—')}</div>
              <div class="muted">${booking.duration} мин · ${formatRub(booking.servicePrice)}</div>
            `;

            
    const masterCell = document.createElement('td');

    const selected = booking.masterId ? state.masters.find(m => m.id === booking.masterId) : null;
    const title = selected ? selected.name : 'Не выбран';

    const eligibleMasters = state.masters.filter(m =>
      (m.serviceIds || []).includes(booking.serviceId)
    );

    if (authState.isAuthorized && eligibleMasters.length) {
      const select = document.createElement('select');
      const empty = document.createElement('option');
      empty.value = '';
      empty.textContent = '— не выбран —';
      select.appendChild(empty);

      eligibleMasters.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.name;
        opt.selected = booking.masterId === m.id;
        select.appendChild(opt);
      });

      select.addEventListener('change', async () => {
        const masterId = select.value === '' ? null : Number(select.value);
        const resp = await apiFetch(`/api/bookings/${booking.id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ masterId })
        });
        if (!resp.ok) { await handleError(resp); select.value = booking.masterId ?? ''; return; }
        await resp.json();
        showBanner('Мастер обновлён для записи');
        loadBookings();
      });

      masterCell.appendChild(select);
    } else {
      masterCell.textContent = title;
    }
    

            const statusCell = document.createElement('td');
            const badge = document.createElement('span');
            badge.className = `status-badge status-${booking.status}`;
            badge.textContent = BOOKING_STATUS_LABELS[booking.status] || booking.status;
            statusCell.appendChild(badge);

            const actionsCell = document.createElement('td');
            actionsCell.className = 'table-actions';

            if (authState.isAuthorized) {
              if (booking.status !== 'confirmed') {
                const confirmBtn = document.createElement('button');
                confirmBtn.type = 'button';
                confirmBtn.className = 'primary-btn';
                confirmBtn.dataset.action = 'confirm-booking';
                confirmBtn.dataset.id = booking.id;
                confirmBtn.textContent = 'Подтвердить';
                actionsCell.appendChild(confirmBtn);
              }

              if (booking.status !== 'cancelled') {
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.className = 'secondary-btn';
                cancelBtn.dataset.action = 'cancel-booking';
                cancelBtn.dataset.id = booking.id;
                cancelBtn.textContent = 'Отменить';
                actionsCell.appendChild(cancelBtn);
              }
            }

            tr.appendChild(timeCell);
            tr.appendChild(clientCell);
            tr.appendChild(serviceCell);
            tr.appendChild(masterCell);
            tr.appendChild(statusCell);
            tr.appendChild(actionsCell);

            bookingsTableBody.appendChild(tr);
          });
      };

      const renderAdminsTable = () => {
        adminsTableBody.innerHTML = '';

        if (!authState.isAuthorized) {
          const row = document.createElement('tr');
          row.className = 'empty-row';
          const cell = document.createElement('td');
          cell.colSpan = 5;
          cell.textContent = 'Доступ к списку администраторов ограничен.';
          row.appendChild(cell);
          adminsTableBody.appendChild(row);
          return;
        }

        if (!state.admins.length) {
          const row = document.createElement('tr');
          row.className = 'empty-row';
          const cell = document.createElement('td');
          cell.colSpan = 5;
          cell.textContent = 'Администраторы не найдены';
          row.appendChild(cell);
          adminsTableBody.appendChild(row);
          return;
        }

        state.admins
          .sort((a, b) => (a.role === 'owner' ? -1 : 1))
          .forEach((admin) => {
            const tr = document.createElement('tr');
            tr.dataset.id = admin.id;

            const idCell = document.createElement('td');
            idCell.textContent = admin.id;

            const usernameCell = document.createElement('td');
            usernameCell.textContent = `@${admin.username}`;

            const nameCell = document.createElement('td');
            nameCell.textContent = admin.displayName || '—';

            const roleCell = document.createElement('td');
            roleCell.textContent = admin.role === 'owner' ? 'Владелец' : 'Администратор';

            const actionsCell = document.createElement('td');
            actionsCell.className = 'table-actions';

            if (authState.role === 'owner' && admin.role !== 'owner') {
              const deleteBtn = document.createElement('button');
              deleteBtn.type = 'button';
              deleteBtn.className = 'danger-btn';
              deleteBtn.dataset.action = 'delete-admin';
              deleteBtn.dataset.id = admin.id;
              deleteBtn.textContent = 'Удалить';
              actionsCell.appendChild(deleteBtn);
            }

            tr.appendChild(idCell);
            tr.appendChild(usernameCell);
            tr.appendChild(nameCell);
            tr.appendChild(roleCell);
            tr.appendChild(actionsCell);

            adminsTableBody.appendChild(tr);
          });
      };

      const loadGroups = async () => {
        const response = await apiFetch('/api/groups');
        if (!response.ok) {
          await handleError(response);
          return;
        }
        state.groups = await response.json();
        renderGroupOptions();
        renderGroupFilter();
        renderGroupsTable();
        renderServicesTable();
      };

      const renderGroupOptions = () => {
        const options = ['<option value="">Без группы</option>'];
        state.groups.forEach((group) => {
          options.push(`<option value="${group.id}">${escapeHtml(group.name)}</option>`);
        });
        serviceFormGroupSelect.innerHTML = options.join('');
      };

      const renderGroupFilter = () => {
        const options = ['<option value="">Все группы</option>'];
        state.groups.forEach((group) => {
          options.push(`<option value="${group.id}">${escapeHtml(group.name)}</option>`);
        });
        groupFilter.innerHTML = options.join('');
        groupFilter.value = state.filterGroupId ?? '';
      };

      const loadServices = async () => {
        const response = await apiFetch('/api/services');
        if (!response.ok) {
          await handleError(response);
          return;
        }
        state.services = await response.json();
        renderServicesTable();
      };

      const loadBookings = async () => {
        if (!authState.telegramId) {
          state.bookings = [];
          renderBookingsTable();
          return;
        }

        const params = new URLSearchParams();
        if (state.bookingStatusFilter !== 'all') {
          params.set('status', state.bookingStatusFilter);
        }

        const url = params.toString() ? `/api/bookings?${params.toString()}` : '/api/bookings';
        const response = await apiFetch(url);
        if (!response.ok) {
          await handleError(response);
          if (response.status === 401 || response.status === 403) {
            state.bookings = [];
            renderBookingsTable();
          }
          return;
        }

        state.bookings = await response.json();
        renderBookingsTable();
      };

      const loadAdmins = async () => {
        if (!authState.isAuthorized) {
          state.admins = [];
          renderAdminsTable();
          return;
        }

        const response = await apiFetch('/api/admins');
        if (!response.ok) {
          await handleError(response);
          return;
        }

        state.admins = await response.json();
        renderAdminsTable();
      };

      bookingStatusFilter.addEventListener('change', (event) => {
        state.bookingStatusFilter = event.target.value;
        loadBookings();
      });

      groupFilter.addEventListener('change', (event) => {
        const value = event.target.value;
        state.filterGroupId = value === '' ? null : Number(value);
        renderServicesTable();
      });

      applyManualIdBtn.addEventListener('click', () => {
        const value = manualTelegramId.value.trim();
        if (!value) {
          showBanner('Введите Telegram ID', 'error');
          return;
        }
        setTelegramId(value);
      });

      clearManualIdBtn.addEventListener('click', () => {
        setTelegramId(null);
      });

      const ensureAuthorized = () => {
        if (!authState.isAuthorized) {
          showBanner('Нет прав для выполнения действия', 'error');
          return false;
        }
        return true;
      };

      const ensureOwner = () => {
        if (authState.role !== 'owner') {
          showBanner('Только владелец может выполнять действие', 'error');
          return false;
        }
        return true;
      };

      serviceForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!ensureAuthorized()) {
          return;
        }

        const formData = new FormData(serviceForm);
        const payload = {
          name: formData.get('name'),
          description: formData.get('description'),
          price: Number(formData.get('price')),
          duration: Number(formData.get('duration')),
          groupId: formData.get('groupId') ? Number(formData.get('groupId')) : null
        };

        const response = await apiFetch('/api/services', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          await handleError(response);
          return;
        }

        const created = await response.json();
        state.services.push(created);
        serviceForm.reset();
        renderServicesTable();
        showBanner('Услуга создана');
      });

      groupForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!ensureAuthorized()) {
          return;
        }

        const formData = new FormData(groupForm);
        const payload = { name: formData.get('name') };

        const response = await apiFetch('/api/groups', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          await handleError(response);
          return;
        }

        const created = await response.json();
        state.groups.push(created);
        groupForm.reset();
        renderGroupOptions();
        renderGroupFilter();
        renderGroupsTable();
        showBanner('Группа создана');
      });

      const updateServiceField = async (id, field, value) => {
        if (!ensureAuthorized()) {
          return null;
        }

        const response = await apiFetch(`/api/services/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [field]: value })
        });

        if (!response.ok) {
          await handleError(response);
          return null;
        }

        const updated = await response.json();
        const index = state.services.findIndex((service) => service.id === id);
        if (index !== -1) {
          state.services[index] = updated;
        }
        return updated;
      };

      servicesTableBody.addEventListener('blur', async (event) => {
        const cell = event.target;
        if (!authState.isAuthorized || cell.dataset.field == null || cell.tagName !== 'TD') {
          return;
        }

        const row = cell.closest('tr');
        const id = Number(row?.dataset.id);
        if (!id) {
          return;
        }

        const service = state.services.find((item) => item.id === id);
        if (!service) {
          return;
        }

        const field = cell.dataset.field;
        let value = cell.textContent.trim();

        if (field === 'price' || field === 'duration') {
          const numberValue = Number(value);
          if (!Number.isFinite(numberValue) || numberValue <= 0) {
            cell.textContent = service[field];
            showBanner('Введите корректное число', 'error');
            return;
          }
          value = numberValue;
        }

        if (!value && (field === 'name' || field === 'description')) {
          cell.textContent = service[field];
          showBanner('Поле не может быть пустым', 'error');
          return;
        }

        const updated = await updateServiceField(id, field, value);
        if (!updated) {
          cell.textContent = service[field];
          return;
        }

        showBanner('Услуга обновлена');
        renderServicesTable();
      }, true);

      servicesTableBody.addEventListener('change', async (event) => {
        const select = event.target;
        if (!authState.isAuthorized || select.dataset.field !== 'groupId') {
          return;
        }

        const row = select.closest('tr');
        const id = Number(row?.dataset.id);
        if (!id) {
          return;
        }

        const value = select.value === '' ? null : Number(select.value);
        const updated = await updateServiceField(id, 'groupId', value);
        if (!updated) {
          const service = state.services.find((item) => item.id === id);
          select.value = service?.groupId ?? '';
          return;
        }
        showBanner('Услуга обновлена');
      });

      servicesTableBody.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-action="delete-service"]');
        if (!button) {
          return;
        }

        if (!ensureAuthorized()) {
          return;
        }

        const id = Number(button.dataset.id);
        if (!id || !confirm('Удалить услугу?')) {
          return;
        }

        const response = await apiFetch(`/api/services/${id}`, { method: 'DELETE' });
        if (!response.ok) {
          await handleError(response);
          return;
        }

        state.services = state.services.filter((service) => service.id !== id);
        renderServicesTable();
        showBanner('Услуга удалена');
      });

      const updateGroupField = async (id, value) => {
        if (!ensureAuthorized()) {
          return null;
        }

        const response = await apiFetch(`/api/groups/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: value })
        });

        if (!response.ok) {
          await handleError(response);
          return null;
        }

        const updated = await response.json();
        const index = state.groups.findIndex((group) => group.id === id);
        if (index !== -1) {
          state.groups[index] = updated;
        }
        return updated;
      };

      groupsTableBody.addEventListener('blur', async (event) => {
        const cell = event.target;
        if (!authState.isAuthorized || cell.dataset.field !== 'name') {
          return;
        }

        const row = cell.closest('tr');
        const id = Number(row?.dataset.id);
        if (!id) {
          return;
        }

        const group = state.groups.find((item) => item.id === id);
        if (!group) {
          return;
        }

        const value = cell.textContent.trim();
        if (!value) {
          cell.textContent = group.name;
          showBanner('Название группы не может быть пустым', 'error');
          return;
        }

        const updated = await updateGroupField(id, value);
        if (!updated) {
          cell.textContent = group.name;
          return;
        }

        renderGroupOptions();
        renderGroupFilter();
        renderServicesTable();
        showBanner('Группа обновлена');
      }, true);

      groupsTableBody.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-action="delete-group"]');
        if (!button) {
          return;
        }

        if (!ensureAuthorized()) {
          return;
        }

        const id = Number(button.dataset.id);
        if (!id || !confirm('Удалить группу? Связанные услуги останутся без группы.')) {
          return;
        }

        const response = await apiFetch(`/api/groups/${id}`, { method: 'DELETE' });
        if (!response.ok) {
          await handleError(response);
          return;
        }

        state.groups = state.groups.filter((group) => group.id !== id);
        state.services = state.services.map((service) =>
          service.groupId === id ? { ...service, groupId: null } : service
        );

        renderGroupOptions();
        renderGroupFilter();
        renderGroupsTable();
        renderServicesTable();
        showBanner('Группа удалена');
      });

      const updateBookingStatus = async (id, status) => {
        if (!ensureAuthorized()) {
          return;
        }

        const response = await apiFetch(`/api/bookings/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });

        if (!response.ok) {
          await handleError(response);
          return;
        }

        await response.json();
        showBanner(status === 'confirmed' ? 'Запись подтверждена' : 'Запись отменена');
        loadBookings();
      };

      bookingsTableBody.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button) {
          return;
        }

        const id = Number(button.dataset.id);
        if (!id) {
          return;
        }

        if (button.dataset.action === 'confirm-booking') {
          updateBookingStatus(id, 'confirmed');
          return;
        }

        if (button.dataset.action === 'cancel-booking') {
          if (!confirm('Отменить запись? Клиент получит уведомление.')) {
            return;
          }
          updateBookingStatus(id, 'cancelled');
        }
      });

      adminForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!ensureOwner()) {
          return;
        }

        const formData = new FormData(adminForm);
        const payload = {
          id: Number(formData.get('id')),
          username: String(formData.get('username')).replace(/^@/, ''),
          displayName: formData.get('displayName') || undefined,
          role: formData.get('role')
        };

        const response = await apiFetch('/api/admins', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          await handleError(response);
          return;
        }

        await response.json();
        adminForm.reset();
        showBanner('Администратор добавлен');
        loadAdmins();
      });

      adminsTableBody.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-action="delete-admin"]');
        if (!button) {
          return;
        }

        if (!ensureOwner()) {
          return;
        }

        const id = Number(button.dataset.id);
        if (!id || !confirm('Удалить администратора?')) {
          return;
        }

        const response = await apiFetch(`/api/admins/${id}`, { method: 'DELETE' });
        if (!response.ok) {
          await handleError(response);
          return;
        }

        showBanner('Администратор удалён');
        loadAdmins();
      });

      const initialId = detectTelegramId();
      if (initialId) {
        authState.telegramId = initialId;
      }
      updateAuthStatus();
      refreshAccess();
      switchTab(state.activeTab);
    });
  
// ===== MASTERS: загрузка =====
const loadMasters = async () => {
  const response = await apiFetch('/api/masters');
  if (!response.ok) {
    await handleError(response);
    state.masters = [];
    renderMastersTable();
    return;
  }
  state.masters = await response.json();
  renderMastersTable();
  renderMasterServiceOptions();
};

// ===== MASTERS: опции услуг и рендер таблицы =====
const renderMasterServiceOptions = () => {
  if (!masterForm) return;
  const select = masterForm.querySelector('select[name="serviceIds"]');
  if (!select) return;
  select.innerHTML = state.services.map(s =>
    `<option value="${s.id}">${escapeHtml(s.name)} (${s.duration} мин)</option>`
  ).join('');
};

const renderMastersTable = () => {
  mastersTableBody.innerHTML = '';

  if (!state.masters.length) {
    const row = document.createElement('tr');
    row.className = 'empty-row';
    const cell = document.createElement('td');
    cell.colSpan = 7;
    cell.textContent = 'Мастеров пока нет';
    row.appendChild(cell);
    mastersTableBody.appendChild(row);
    return;
  }

  state.masters.forEach((m) => {
    const tr = document.createElement('tr');
    tr.dataset.id = m.id;
    const editable = authState.isAuthorized;

    const photo = document.createElement('td');
    photo.innerHTML = m.photoUrl ? `<img src="${escapeHtml(m.photoUrl)}" alt="" style="width:44px;height:44px;border-radius:10px;object-fit:cover;border:1px solid rgba(148,163,184,.35)" />` : '—';

    const name = document.createElement('td');
    name.dataset.field = 'name';
    if (editable) name.contentEditable = 'true';
    name.textContent = m.name || '';

    const spec = document.createElement('td');
    spec.dataset.field = 'specialties';
    if (editable) spec.contentEditable = 'true';
    spec.textContent = (m.specialties || []).join(', ');

    const desc = document.createElement('td');
    desc.dataset.field = 'description';
    if (editable) desc.contentEditable = 'true';
    desc.textContent = m.description || '';

    const sched = document.createElement('td');
    const s = m.schedule || {};
    if (s.type === 'weekly') {
      const w = s.weekly || {};
      const daysLabel = (w.days || []).map(d => ['Вс','Пн','Вт','Ср','Чт','Пт','Сб'][d]).join(', ');
      sched.innerHTML = `Недели: <div class="muted">${daysLabel || '—'}</div><div class="muted">${w.start||'—'}–${w.end||'—'}</div>`;
    } else if (s.type === 'shift') {
      const sh = s.shift || {};
      sched.innerHTML = `Смены: <div class="muted">${sh.workDays||'?'} раб / ${sh.restDays||'?'} вых</div><div class="muted">${sh.start||'—'}–${sh.end||'—'}</div>`;
    } else {
      sched.textContent = '—';
    }

    const servicesCell = document.createElement('td');
    const names = (m.serviceIds || [])
      .map(id => state.services.find(svc => svc.id === id)?.name)
      .filter(Boolean);
    servicesCell.innerHTML = names.length ? names.map(n => `<div>${escapeHtml(n)}</div>`).join('') : '—';
    if (editable) {
      const select = document.createElement('select');
      select.multiple = true;
      select.size = 5;
      select.dataset.field = 'serviceIds';
      state.services.forEach(svc => {
        const opt = document.createElement('option');
        opt.value = svc.id;
        opt.textContent = svc.name;
        opt.selected = (m.serviceIds || []).includes(svc.id);
        select.appendChild(opt);
      });
      servicesCell.appendChild(select);
    }

    const actions = document.createElement('td');
    actions.className = 'table-actions';
    if (editable) {
      const del = document.createElement('button');
      del.type = 'button';
      del.className = 'danger-btn';
      del.dataset.action = 'delete-master';
      del.dataset.id = m.id;
      del.textContent = 'Удалить';
      actions.appendChild(del);
    }

    tr.append(photo, name, spec, desc, sched, servicesCell, actions);
    mastersTableBody.appendChild(tr);
  });
};


// ===== MASTERS: обработчики формы и CRUD =====
masterForm?.addEventListener('change', (e) => {
  if (e.target.name === 'scheduleType') {
    const type = e.target.value;
    masterForm.querySelector('[data-schedule="weekly"]').style.display = (type === 'weekly') ? 'grid' : 'none';
    masterForm.querySelector('[data-schedule="shift"]').style.display = (type === 'shift') ? 'grid' : 'none';
  }
});

masterForm?.addEventListener('submit', async (event) => {
  event.preventDefault();
  if (!authState.isAuthorized) {
    showBanner('Нет прав для выполнения действия', 'error');
    return;
  }

  const fd = new FormData(masterForm);
  const scheduleType = fd.get('scheduleType');

  const specialties = String(fd.get('specialties') || '')
    .split(',')
    .map(s => s.trim())
    .filter(Boolean);

  const serviceIds = Array.from(masterForm.querySelector('select[name="serviceIds"]').selectedOptions)
    .map(o => Number(o.value));

  const payload = {
    name: fd.get('name'),
    specialties,
    photoUrl: fd.get('photoUrl') || undefined,
    description: fd.get('description') || '',
    schedule: scheduleType === 'weekly' ? {
      type: 'weekly',
      weekly: {
        days: Array.from(masterForm.querySelectorAll('input[name="weeklyDays"]:checked')).map(i => Number(i.value)),
        start: fd.get('weeklyStart') || '10:00',
        end: fd.get('weeklyEnd') || '19:00'
      }
    } : {
      type: 'shift',
      shift: {
        workDays: Number(fd.get('shiftWork') || 2),
        restDays: Number(fd.get('shiftRest') || 2),
        anchorDate: fd.get('shiftAnchor') || new Date().toISOString().slice(0,10),
        start: fd.get('shiftStart') || '10:00',
        end: fd.get('shiftEnd') || '19:00'
      }
    },
    serviceIds
  };

  const response = await apiFetch('/api/masters', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  if (!response.ok) {
    await handleError(response);
    return;
  }

  const created = await response.json();
  state.masters.push(created);
  masterForm.reset();
  renderMastersTable();
  showBanner('Мастер добавлен');
});

const updateMasterField = async (id, patch) => {
  const response = await apiFetch(`/api/masters/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(patch)
  });
  if (!response.ok) {
    await handleError(response);
    return null;
  }
  const updated = await response.json();
  const idx = state.masters.findIndex(m => m.id === id);
  if (idx !== -1) state.masters[idx] = updated;
  return updated;
};

mastersTableBody?.addEventListener('blur', async (e) => {
  const cell = e.target;
  if (!authState.isAuthorized || cell.tagName !== 'TD' || !cell.dataset.field) return;
  const row = cell.closest('tr'); const id = Number(row?.dataset.id);
  const master = state.masters.find(m => m.id === id); if (!id || !master) return;

  const field = cell.dataset.field;
  let value = cell.textContent.trim();

  if (!value && (field === 'name')) {
    cell.textContent = master[field] || '';
    showBanner('Имя не может быть пустым', 'error'); return;
  }

  if (field === 'specialties') {
    value = value ? value.split(',').map(s => s.trim()).filter(Boolean) : [];
    const ok = await updateMasterField(id, { specialties: value });
    if (!ok) cell.textContent = (master.specialties||[]).join(', ');
    else showBanner('Мастер обновлён');
    return;
  }

  const ok = await updateMasterField(id, { [field]: value });
  if (!ok) cell.textContent = master[field] || '';
  else showBanner('Мастер обновлён');
}, true);

mastersTableBody?.addEventListener('change', async (e) => {
  const target = e.target;
  if (target.dataset.field === 'serviceIds') {
    const row = target.closest('tr'); const id = Number(row?.dataset.id);
    const selected = Array.from(target.selectedOptions).map(o => Number(o.value));
    const ok = await updateMasterField(id, { serviceIds: selected });
    if (ok) showBanner('Услуги мастера обновлены');
  }
});

mastersTableBody?.addEventListener('click', async (e) => {
  const btn = e.target.closest('button[data-action="delete-master"]');
  if (!btn) return;
  if (!authState.isAuthorized) { showBanner('Нет прав', 'error'); return; }
  const id = Number(btn.dataset.id);
  if (!id || !confirm('Удалить мастера?')) return;
  const response = await apiFetch(`/api/masters/${id}`, { method: 'DELETE' });
  if (!response.ok) { await handleError(response); return; }
  state.masters = state.masters.filter(m => m.id !== id);
  renderMastersTable();
  showBanner('Мастер удалён');
});

</script>
</body>
</html>
